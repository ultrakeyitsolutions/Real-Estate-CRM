@model List<CRM.Models.PropertyModel>
@{
    ViewData["Title"] = "Properties Management";
}

<style>
    .modern-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        position: relative;
        overflow: hidden;
        border-radius: 12px;
        margin-bottom: 1rem;
        box-shadow: 0 8px 32px rgba(102, 126, 234, 0.15);
    }

    .modern-header::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="50" cy="50" r="1" fill="%23ffffff" opacity="0.1"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>') repeat;
        opacity: 0.3;
    }

    .header-content {
        position: relative;
        z-index: 2;
        padding: 2.5rem 2rem;
        color: white;
    }

    .header-title {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .header-subtitle {
        font-size: 1.1rem;
        opacity: 0.9;
        margin-bottom: 2rem;
        font-weight: 400;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1.25rem;
        margin-top: 1.5rem;
    }

    .stats-card {
        background: rgba(255, 255, 255, 0.15);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 10px;
        padding: 1.5rem;
        text-align: center;
        transition: all 0.3s ease;
    }

    .stats-card:hover {
        background: rgba(255, 255, 255, 0.25);
        transform: translateY(-2px);
    }

    .stats-number {
        font-size: 2.2rem;
        font-weight: 800;
        margin-bottom: 0.5rem;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .stats-label {
        font-size: 0.8rem;
        opacity: 0.9;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .action-btn {
        background: rgba(255, 255, 255, 0.2);
        border: 2px solid rgba(255, 255, 255, 0.3);
        color: white;
        padding: 0.875rem 2rem;
        border-radius: 50px;
        font-weight: 600;
        font-size: 1rem;
        backdrop-filter: blur(10px);
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        margin: 0.5rem;
    }

    .action-btn:hover {
        background: rgba(255, 255, 255, 0.3);
        border-color: rgba(255, 255, 255, 0.5);
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        color: white;
    }

    .filter-section {
        background: white;
        border-radius: 16px;
        padding: 2rem;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        margin-bottom: 2rem;
        border: 1px solid rgba(0, 0, 0, 0.05);
    }

    .filter-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: #2d3748;
        margin-bottom: 1.5rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .property-card {
        background: white;
        border-radius: 16px;
        padding: 1.5rem;
        margin-bottom: 1rem;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        border: 1px solid rgba(0, 0, 0, 0.05);
        transition: all 0.3s ease;
    }

    .property-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
        border-color: rgba(102, 126, 234, 0.2);
    }

    .property-name {
        font-size: 1.25rem;
        font-weight: 600;
        color: #2d3748;
        text-decoration: none;
        margin-bottom: 0.5rem;
        display: block;
    }

    .property-name:hover {
        color: #667eea;
        text-decoration: none;
    }

    .property-info {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 0.5rem;
        color: #6b7280;
        font-size: 0.9rem;
    }

    .property-image {
        width: 80px;
        height: 80px;
        object-fit: cover;
        border-radius: 12px;
        border: 2px solid rgba(102, 126, 234, 0.1);
    }

    .action-buttons {
        display: flex;
        gap: 0.5rem;
        justify-content: flex-end;
    }

    .btn-action {
        padding: 0.5rem 1rem;
        border-radius: 8px;
        font-size: 0.875rem;
        font-weight: 500;
        border: none;
        cursor: pointer;
        transition: all 0.2s ease;
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
    }

    .btn-edit {
        background-color: #3b82f6;
        color: white;
    }

    .btn-edit:hover {
        background-color: #2563eb;
        transform: translateY(-1px);
    }

    .btn-delete {
        background-color: #ef4444;
        color: white;
    }

    .btn-delete:hover {
        background-color: #dc2626;
        transform: translateY(-1px);
    }

    .empty-state {
        text-align: center;
        padding: 4rem 2rem;
        background: white;
        border-radius: 16px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        border: 1px solid rgba(0, 0, 0, 0.05);
    }

    .empty-state i {
        font-size: 5rem;
        color: #e5e7eb;
        margin-bottom: 1.5rem;
    }

    .pagination-wrapper {
        background: white;
        border-radius: 16px;
        padding: 1.5rem;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        border: 1px solid rgba(0, 0, 0, 0.05);
        margin-top: 2rem;
    }

    @@media (max-width: 768px) {
        .header-content {
            padding: 2rem 1.5rem;
        }
        
        .header-title {
            font-size: 2rem;
        }
        
        .stats-grid {
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }
        
        .stats-number {
            font-size: 1.8rem;
        }
        
        .filter-section {
            padding: 1.5rem;
        }

        .property-card {
            padding: 1rem;
        }

        .action-buttons {
            justify-content: center;
            margin-top: 1rem;
        }
    }
    
    @@media (max-width: 576px) {
        .stats-grid {
            grid-template-columns: 1fr;
        }
        
        .action-btn {
            width: 100%;
            justify-content: center;
            margin: 0.25rem 0;
        }
    }

    .dark-mode .filter-section {
        background: #222639 !important;
        border-color: #2c3049 !important;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3) !important;
    }
    
    .dark-mode .filter-title {
        color: #e4e6eb !important;
    }
    
    .dark-mode .property-card {
        background: #222639 !important;
        border-color: #2c3049 !important;
        color: #e4e6eb !important;
    }
    
    .dark-mode .property-name {
        color: #a78bfa !important;
    }
    
    .dark-mode .property-info {
        color: #a6adc8 !important;
    }
    
    .dark-mode .empty-state {
        background: #222639 !important;
        border-color: #2c3049 !important;
        color: #e4e6eb !important;
    }
    
    .dark-mode .pagination-wrapper {
        background: #222639 !important;
        border-color: #2c3049 !important;
    }
</style>

<!-- Success/Error Messages -->
@if (TempData["Success"] != null)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        <i class="fas fa-check-circle me-2"></i>@TempData["Success"]
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}
@if (TempData["Error"] != null)
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <i class="fas fa-exclamation-circle me-2"></i>@TempData["Error"]
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}

<div class="content">
    <!-- Breadcrumb -->
    <nav class="mb-3" aria-label="breadcrumb" style="background: transparent; padding: 0;">
        <ol class="breadcrumb mb-0" style="background: transparent; padding: 0; font-size: 0.875rem;">
            <li class="breadcrumb-item"><a href="/Home/Index" style="color: #6b7280; text-decoration: none;">Home</a></li>
            <li class="breadcrumb-item active" style="color: #9ca3af;">Properties</li>
        </ol>
    </nav>

    <!-- Modern Header with Stats -->
    <div class="modern-header">
        <div class="header-content" style="padding: 1.25rem 1.5rem;">
            <div class="d-flex align-items-center justify-content-between flex-wrap gap-3">
                <div class="d-flex align-items-center gap-3 flex-grow-1">
                    <i class="fa-solid fa-building" style="font-size: 1.5rem; opacity: 0.9;"></i>
                    <div>
                        <h1 class="mb-0" style="font-size: 1.5rem; font-weight: 700;">Properties Management</h1>
                        <p class="mb-0" style="font-size: 0.8rem; opacity: 0.9;">Manage all properties and track their performance efficiently</p>
                    </div>
                </div>
                
                <div class="d-flex align-items-center gap-2 flex-wrap">
                    @if (User.IsInRole("Admin") || User.IsInRole("Sales") || User.IsInRole("Agent"))
                    {
                        <button type="button" class="action-btn" style="padding: 0.5rem 1.25rem; font-size: 0.875rem; margin: 0;" data-bs-toggle="modal" data-bs-target="#addPropertyModal">
                            <i class="fa-solid fa-plus"></i>
                            <span>Add Property</span>
                        </button>
                    }
                    @if (User.IsInRole("Admin") || User.IsInRole("Sales") || User.IsInRole("Agent"))
                    {
                        <button type="button" class="action-btn" style="padding: 0.5rem 1.25rem; font-size: 0.875rem; margin: 0;" data-bs-toggle="modal" data-bs-target="#bulkUploadModal">
                            <i class="fa-solid fa-upload"></i>
                            <span>Bulk Upload</span>
                        </button>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- Filter Section -->
    <div class="filter-section">
        <div class="filter-title">
            <i class="fa-solid fa-filter"></i>
            <span>Filter & Search</span>
        </div>
        <div class="row g-3">
            <div class="col-md-4">
                <label for="searchBox" class="form-label fw-semibold">
                    <i class="fa-solid fa-search text-muted me-2"></i>Search Properties
                </label>
                <input type="text" class="form-control" id="searchBox" 
                       placeholder="Search by name, location, builder...">
            </div>
            <div class="col-md-3">
                <label for="filterBuilder" class="form-label fw-semibold">Builder</label>
                <select id="filterBuilder" class="form-select">
                    <option value="">üèóÔ∏è All Builders</option>
                    @if (ViewBag.Builders != null)
                    {
                        foreach (var builder in ViewBag.Builders)
                        {
                            <option value="@builder.BuilderId">@builder.BuilderName</option>
                        }
                    }
                </select>
            </div>
@if (ViewBag.IsPartnerTeam != true)
{
    <div class="col-md-3">
        <label for="filterAssignedTo" class="form-label fw-semibold">Assigned To</label>
        <select id="filterAssignedTo" class="form-select">
            <option value="">üë§ All Sales</option>
            @if (ViewBag.Executives != null)
            {
                foreach (var exec in ViewBag.Executives)
                {
                    <option value="@exec.UserId">@exec.Username</option>
                }
            }
        </select>
    </div>
}
        </div>
        <div class="row mt-3">
            <div class="col-md-6">
                <button type="button" class="btn btn-outline-primary" onclick="clearFilters()">
                    <i class="fa-solid fa-refresh me-1"></i>Clear Filters
                </button>
            </div>
            <div class="col-md-6 text-end">
                @if (User.IsInRole("Admin") || User.IsInRole("Sales") || User.IsInRole("Agent"))
                {
                    <button type="button" class="btn btn-success me-2" id="exportExcel">
                        <i class="fa-solid fa-file-excel me-1"></i>Export Excel
                    </button>
                    <button type="button" class="btn btn-info me-2" id="exportCSV">
                        <i class="fa-solid fa-file-csv me-1"></i>Export CSV
                    </button>
                }
            </div>
        </div>
    </div>

    <!-- Properties List -->
    <div id="propertiesContainer">
        <!-- Properties will be populated by JavaScript -->
    </div>

    <!-- Pagination -->
    <div class="pagination-wrapper" id="paginationWrapper" style="display: none;">
        <div class="row align-items-center">
            <div class="col-md-6">
                <p class="text-muted mb-0">Showing <span id="showingStart">0</span> to <span id="showingEnd">0</span> of <span id="totalRecords">0</span> entries</p>
            </div>
            <div class="col-md-6">
                <nav>
                    <ul class="pagination justify-content-end mb-0" id="pagination">
                        <!-- Pagination will be generated by JavaScript -->
                    </ul>
                </nav>
            </div>
        </div>
    </div>
</div>

<!-- Add/Edit Property Modal -->
@await Html.PartialAsync("_PropertyModal")

<!-- Bulk Upload Modal -->
<div class="modal fade" id="bulkUploadModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" style="max-width: 500px !important; width: 500px;">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Bulk Upload Properties</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="bulkUploadForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Upload Excel File <span class="text-danger">*</span></label>
                        <input type="file" class="form-control" id="bulkUploadFile" accept=".xlsx,.xls" required>
                        <div class="form-text">Upload Excel file with properties and flats data</div>
                    </div>
                    <div class="p-3 mb-3 d-flex align-items-center justify-content-between" style="background-color: #e7f3ff; border: 1px solid #b3d9ff; border-radius: 8px;">
                        <div style="color: #004085;">
                            <i class="fa-solid fa-info-circle me-2"></i>Download sample template to see the required format
                        </div>
                        <button type="button" class="btn btn-sm btn-primary" id="downloadSample">
                            <i class="fa-solid fa-download me-1"></i>Download
                        </button>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">Upload Properties</button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <!-- SheetJS for Excel operations -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script>
        // Global variables
        let allProperties = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model));
        let filteredProperties = [...allProperties];
        let currentPage = 1;
        let pageSize = 10;
        let isEditMode = false;
        let userRole = '@User.FindFirst(System.Security.Claims.ClaimTypes.Role)?.Value';
        
        // Permission check functions
        function canEdit() {
            return userRole === 'Admin' || userRole === 'Sales' || userRole === 'Agent';
        }
        
        function canDelete() {
            return userRole === 'Admin' || userRole === 'Sales' || userRole === 'Agent';
        }
        
        function getEditButton(propertyId) {
            if (canEdit()) {
                return `<button class="btn-action btn-edit" onclick="editProperty(${propertyId})" title="Edit Property">
                    <i class="fa-solid fa-edit"></i>
                </button>`;
            }
            return '';
        }
        
        function getDeleteButton(propertyId) {
            if (canDelete()) {
                return `<button class="btn-action btn-delete" onclick="deleteProperty(${propertyId})" title="Delete Property">
                    <i class="fa-solid fa-trash"></i>
                </button>`;
            }
            return '';
        }

        // Builders and executives data from server
        let builders = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(ViewBag.Builders ?? new object[0]));
        let executives = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(ViewBag.Executives ?? new object[0]));

        // Helper function to get builder name
        function getBuilderName(builderId) {
            if (!builderId || !builders) return '-';
            const builder = builders.find(b => b.BuilderId === builderId);
            return builder ? builder.BuilderName : '-';
        }

        // Helper function to get executive name
        function getExecutiveName(executiveId) {
            if (!executiveId || !executives) return '-';
            const exec = executives.find(e => e.UserId === executiveId);
            return exec ? exec.FullName : '-';
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function () {
            renderTable();
            attachEventListeners();

            // Auto-dismiss alerts
            setTimeout(() => {
                document.querySelectorAll('.alert').forEach(alert => {
                    bootstrap.Alert.getOrCreateInstance(alert).close();
                });
            }, 5000);
        });

        function attachEventListeners() {
            // Search
            document.getElementById('searchBox').addEventListener('input', applyFilters);

            // Filters
            document.getElementById('filterBuilder').addEventListener('change', applyFilters);
            document.getElementById('filterAssignedTo').addEventListener('change', applyFilters);

            // Export buttons
            document.getElementById('exportExcel').addEventListener('click', exportToExcel);
            document.getElementById('exportCSV').addEventListener('click', exportToCSV);

            // Download sample
            document.getElementById('downloadSample').addEventListener('click', downloadSample);

            // Form submissions
            document.getElementById('bulkUploadForm').addEventListener('submit', handleBulkUpload);
        }

        function applyFilters() {
            const searchText = document.getElementById('searchBox').value.toLowerCase();
            const builderId = document.getElementById('filterBuilder').value;
            const assignedTo = document.getElementById('filterAssignedTo').value;

            filteredProperties = allProperties.filter(property => {
                const propertyName = (property.PropertyName || '').toString();
                const location = (property.Location || '').toString();
                const propBuilderId = property.BuilderId;
                const propAssignedTo = property.AssignedTo;
                
                // Search filter
                const matchesSearch = !searchText ||
                    propertyName.toLowerCase().includes(searchText) ||
                    location.toLowerCase().includes(searchText) ||
                    getBuilderName(propBuilderId).toLowerCase().includes(searchText);

                // Builder filter
                const matchesBuilder = !builderId || propBuilderId == parseInt(builderId);

                // Assigned To filter
                const matchesAssignedTo = !assignedTo || propAssignedTo == parseInt(assignedTo);

                return matchesSearch && matchesBuilder && matchesAssignedTo;
            });

            currentPage = 1;
            renderTable();
        }

        function clearFilters() {
            document.getElementById('searchBox').value = '';
            document.getElementById('filterBuilder').value = '';
            document.getElementById('filterAssignedTo').value = '';
            filteredProperties = [...allProperties];
            currentPage = 1;
            renderTable();
        }

        function renderTable() {
            const container = document.getElementById('propertiesContainer');
            const start = (currentPage - 1) * pageSize;
            const end = start + pageSize;
            const paginatedProperties = filteredProperties.slice(start, end);

            container.innerHTML = '';

            if (paginatedProperties.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fa-solid fa-building"></i>
                        <h3>No Properties Found</h3>
                        <p class="text-muted">Start by adding your first property or adjust your filters</p>
                        <button type="button" class="btn btn-primary mt-3" data-bs-toggle="modal" data-bs-target="#addPropertyModal">
                            <i class="fa-solid fa-plus me-2"></i>Add Property
                        </button>
                    </div>
                `;
                document.getElementById('paginationWrapper').style.display = 'none';
            } else {
                paginatedProperties.forEach(property => {
                    const propertyCard = document.createElement('div');
                    propertyCard.className = 'property-card';
                    
                    // Property image display
                    let imageHtml = '<div class="property-image d-flex align-items-center justify-content-center bg-light text-muted" style="width: 80px; height: 80px; border-radius: 12px;"><i class="fa-solid fa-image"></i></div>';
                    if (property.PropertyImage) {
                        try {
                            if (typeof property.PropertyImage === 'string') {
                                imageHtml = `<img src="data:image/jpeg;base64,${property.PropertyImage}" class="property-image" alt="Property">`;
                            } else if (property.PropertyImage.length > 0) {
                                const bytes = new Uint8Array(property.PropertyImage);
                                let binary = '';
                                for (let i = 0; i < bytes.length; i++) {
                                    binary += String.fromCharCode(bytes[i]);
                                }
                                const base64 = btoa(binary);
                                imageHtml = `<img src="data:image/jpeg;base64,${base64}" class="property-image" alt="Property">`;
                            }
                        } catch (e) {
                            console.error('Error converting image:', e);
                        }
                    }
                    
                    const propertyId = property.PropertyId;
                    const propertyName = property.PropertyName || 'Unnamed Property';
                    const location = property.Location || 'No location';
                    const areaSqft = property.AreaSqft;
                    const price = property.Price;
                    const builderId = property.BuilderId;
                    const assignedTo = property.AssignedTo;
                    const createdOn = property.CreatedOn;
                    
                    propertyCard.innerHTML = `
                        <div class="row align-items-center g-3">
                            <div class="col-auto">
                                <div style="width: 80px; height: 80px; flex-shrink: 0;">
                                    ${imageHtml}
                                </div>
                            </div>
                            <div class="col-md-3">
                                <a href="/Properties/Details/${propertyId}" class="property-name">
                                    ${propertyName}
                                </a>
                                <div class="property-info">
                                    <i class="fa-solid fa-map-marker-alt"></i>
                                    <span>${location}</span>
                                </div>
                                <div class="property-info">
                                    <i class="fa-solid fa-hashtag"></i>
                                    <span>ID: ${propertyId}</span>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="property-info">
                                    <i class="fa-solid fa-hammer"></i>
                                    <span>${getBuilderName(builderId)}</span>
                                </div>
                                <div class="property-info">
                                    <i class="fa-solid fa-user-tie"></i>
                                    <span>${getExecutiveName(assignedTo)}</span>
                                </div>
                                <div class="property-info">
                                    <i class="fa-solid fa-calendar"></i>
                                    <span>${formatDate(createdOn)}</span>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="property-info">
                                    <i class="fa-solid fa-ruler-combined"></i>
                                    <span>${areaSqft || 'N/A'} sqft</span>
                                </div>
                                <div class="property-info">
                                    <i class="fa-solid fa-tag"></i>
                                    <span>‚Çπ${price ? price.toLocaleString() : 'N/A'}</span>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="action-buttons">
                                    ${getEditButton(propertyId)}
                                    ${getDeleteButton(propertyId)}
                                </div>
                            </div>
                        </div>
                    `;
                    container.appendChild(propertyCard);
                });
                document.getElementById('paginationWrapper').style.display = 'block';
            }

            updatePaginationInfo();
            renderPagination();
            updateStats();
        }

        function updateStats() {
            const totalPropertiesElement = document.getElementById('totalProperties');
            if (totalPropertiesElement) {
                totalPropertiesElement.textContent = filteredProperties.length;
            }
        }

        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-GB');
        }

        function updatePaginationInfo() {
            const total = filteredProperties.length;
            const start = total === 0 ? 0 : (currentPage - 1) * pageSize + 1;
            const end = Math.min(currentPage * pageSize, total);

            document.getElementById('showingStart').textContent = start;
            document.getElementById('showingEnd').textContent = end;
            document.getElementById('totalRecords').textContent = total;
        }

        function renderPagination() {
            const pagination = document.getElementById('pagination');
            const totalPages = Math.ceil(filteredProperties.length / pageSize);

            pagination.innerHTML = '';

            if (totalPages <= 1) {
                const singleLi = document.createElement('li');
                singleLi.className = 'page-item active';
                singleLi.innerHTML = `<span class="page-link">1</span>`;
                pagination.appendChild(singleLi);
                return;
            }

            // Previous button
            const prevLi = document.createElement('li');
            prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
            prevLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${currentPage - 1}); return false;" aria-label="Previous">
                        <span aria-hidden="true"><span class="d-none d-sm-inline">Previous</span><span class="d-inline d-sm-none">&laquo;</span></span>
                    </a>`;
            pagination.appendChild(prevLi);

            // Page numbers
            const startPage = Math.max(1, currentPage - 2);
            const endPage = Math.min(totalPages, currentPage + 2);

            if (startPage > 1) {
                const firstLi = document.createElement('li');
                firstLi.className = 'page-item';
                firstLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(1); return false;">1</a>`;
                pagination.appendChild(firstLi);

                if (startPage > 2) {
                    const dotsLi = document.createElement('li');
                    dotsLi.className = 'page-item disabled';
                    dotsLi.innerHTML = `<span class="page-link">...</span>`;
                    pagination.appendChild(dotsLi);
                }
            }

            for (let i = startPage; i <= endPage; i++) {
                const li = document.createElement('li');
                li.className = `page-item ${i === currentPage ? 'active' : ''}`;
                li.innerHTML = `<a class="page-link" href="#" onclick="changePage(${i}); return false;">${i}</a>`;
                pagination.appendChild(li);
            }

            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    const dotsLi = document.createElement('li');
                    dotsLi.className = 'page-item disabled';
                    dotsLi.innerHTML = `<span class="page-link">...</span>`;
                    pagination.appendChild(dotsLi);
                }

                const lastLi = document.createElement('li');
                lastLi.className = 'page-item';
                lastLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${totalPages}); return false;">${totalPages}</a>`;
                pagination.appendChild(lastLi);
            }

            // Next button
            const nextLi = document.createElement('li');
            nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
            nextLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${currentPage + 1}); return false;" aria-label="Next">
                        <span aria-hidden="true"><span class="d-none d-sm-inline">Next</span><span class="d-inline d-sm-none">&raquo;</span></span>
                    </a>`;
            pagination.appendChild(nextLi);
        }

        function changePage(page) {
            const totalPages = Math.ceil(filteredProperties.length / pageSize);
            if (page < 1 || page > totalPages) return;
            currentPage = page;
            renderTable();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function editProperty(id) {
            // Fetch property data and populate modal
            fetch(`/Properties/GetProperty?id=${id}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        if (window.populatePropertyModal) {
                            window.populatePropertyModal(data);
                        }
                        new bootstrap.Modal(document.getElementById('addPropertyModal')).show();
                    } else {
                        showToast(data.message || 'Error loading property', 'error');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showToast('Error loading property', 'error');
                });
        }

        function deleteProperty(id) {
            if (!confirm('Are you sure you want to delete this property?')) return;

            fetch(`/Properties/Delete?id=${id}`, {
                method: 'POST'
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Remove from client-side arrays
                        allProperties = allProperties.filter(p => p.PropertyId !== id);
                        filteredProperties = filteredProperties.filter(p => p.PropertyId !== id);
                        renderTable();
                        showToast('Property deleted successfully!', 'success');
                    } else {
                        showToast(data.message || 'Error deleting property', 'error');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showToast('Error deleting property', 'error');
                });
        }

        function downloadSample() {
            // Create sample data for properties
            const sampleData = [
                ['Property Name', 'Builder Name', 'Location', 'Area (Sqft)', 'Price', 'Purchase Type', 'Flat Number', 'Floor Number', 'Unit', 'Property Group', 'Inventory', 'Assigned To (User ID)'],
                ['Sample Property 1', 'Sample Builder', 'Hyderabad', '1200', '5000000', 'Sale', '101', '1', 'Sqft', 'Residential', 'Available', '1'],
                ['Sample Property 2', 'Sample Builder', 'Bangalore', '1500', '7500000', 'Rent', '201', '2', 'Sqft', 'Commercial', 'Sold', '1']
            ];
            
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(sampleData);
            ws['!cols'] = [{ wch: 25 }, { wch: 20 }, { wch: 15 }, { wch: 12 }, { wch: 15 }, { wch: 15 }, { wch: 12 }, { wch: 12 }, { wch: 10 }, { wch: 15 }, { wch: 12 }, { wch: 20 }];
            XLSX.utils.book_append_sheet(wb, ws, 'Properties');
            XLSX.writeFile(wb, 'Properties_Sample_Template.xlsx');
            
            showToast('Sample template downloaded!', 'success');
        }

        function exportToExcel() {
            if (filteredProperties.length === 0) {
                showToast('No data to export', 'error');
                return;
            }

            const ws_data = [
                ['Property ID', 'Property Name', 'Builder', 'Location', 'Area (Sqft)', 'Price', 'Purchase Type',
                    'Assigned To', 'Created Date']
            ];

            filteredProperties.forEach(property => {
                ws_data.push([
                    property.PropertyId || '',
                    property.PropertyName || '',
                    getBuilderName(property.BuilderId),
                    property.Location || '',
                    property.AreaSqft || '',
                    property.Price || '',
                    property.PurchaseType || '',
                    getExecutiveName(property.AssignedTo),
                    formatDate(property.CreatedOn)
                ]);
            });

            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(ws_data);

            // Set column widths
            ws['!cols'] = [
                { wch: 12 }, { wch: 25 }, { wch: 20 }, { wch: 20 }, { wch: 12 }, { wch: 15 },
                { wch: 15 }, { wch: 20 }, { wch: 15 }
            ];

            XLSX.utils.book_append_sheet(wb, ws, "Properties");
            XLSX.writeFile(wb, `Properties_Export_${new Date().toISOString().split('T')[0]}.xlsx`);

            showToast('Excel exported successfully!', 'success');
        }

        function exportToCSV() {
            if (filteredProperties.length === 0) {
                showToast('No data to export', 'error');
                return;
            }

            let csv = 'Property ID,Property Name,Builder,Location,Area (Sqft),Price,Purchase Type,Assigned To,Created Date\n';

            filteredProperties.forEach(property => {
                csv += [
                    property.PropertyId || '',
                    escapeCSV(property.PropertyName),
                    escapeCSV(getBuilderName(property.BuilderId)),
                    escapeCSV(property.Location),
                    property.AreaSqft || '',
                    property.Price || '',
                    escapeCSV(property.PurchaseType),
                    escapeCSV(getExecutiveName(property.AssignedTo)),
                    formatDate(property.CreatedOn)
                ].join(',') + '\n';
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Properties_Export_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);

            showToast('CSV exported successfully!', 'success');
        }

        function escapeCSV(value) {
            if (!value) return '';
            value = value.toString();
            if (value.includes(',') || value.includes('"') || value.includes('\n')) {
                return '"' + value.replace(/"/g, '""') + '"';
            }
            return value;
        }

        function handleBulkUpload(e) {
            e.preventDefault();

            const fileInput = document.getElementById('bulkUploadFile');
            const file = fileInput.files[0];

            if (!file) {
                showToast('Please select a file', 'error');
                return;
            }

            const formData = new FormData();
            formData.append('file', file);

            // Add anti-forgery token
            const token = document.querySelector('input[name="__RequestVerificationToken"]');
            if (token) {
                formData.append('__RequestVerificationToken', token.value);
            }

            fetch('/Properties/BulkUpload', {
                method: 'POST',
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showToast(data.message || 'Bulk upload successful!', 'success');
                        bootstrap.Modal.getInstance(document.getElementById('bulkUploadModal')).hide();

                        // Reload page to get updated data
                        setTimeout(() => location.reload(), 1500);
                    } else {
                        showToast(data.message || 'Error uploading file', 'error');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showToast('Error uploading file', 'error');
                });
        }

        function showToast(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type === 'success' ? 'success' : 'danger'} alert-dismissible fade show position-fixed`;
            alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            alertDiv.innerHTML = `
                        <i class="fa-solid fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'} me-2"></i>
                        ${message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    `;

            document.body.appendChild(alertDiv);

            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }

        // Reload properties when modal is saved
        window.addEventListener('property-saved', function () {
            setTimeout(() => location.reload(), 1000);
        });
    </script>
}