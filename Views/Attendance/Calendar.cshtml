@{
    ViewData["Title"] = "Attendance Management";
    var agentId = (int)ViewBag.AgentId;
    var attendance = ViewBag.Attendance as List<CRM.Models.AgentAttendanceModel> ?? new List<CRM.Models.AgentAttendanceModel>();
    var todayIntervals = ViewBag.TodayLogIntervals as List<(DateTime, DateTime?)>;
    var hasActiveSession = todayIntervals != null && todayIntervals.Any(i => !i.Item2.HasValue);
    var todayAttendance = attendance.FirstOrDefault(a => a.Date.Date == DateTime.Today);
    var isAdmin = User.IsInRole("Admin");
    var isPartner = User.IsInRole("Partner");
    var canManageAttendance = isAdmin || isPartner;
}

<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet" />
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>

<style>
    .modern-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        color: white;
        padding: 20px;
        margin-bottom: 20px;
    }
    .stats-card {
        background: white;
        border-radius: 10px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        padding: 15px;
        margin: 10px 0;
        border-left: 4px solid #007bff;
    }
    .dark-mode .stats-card {
        background: #222639 !important;
        color: #e4e6eb !important;
        box-shadow: 0 5px 15px rgba(255,255,255,0.05) !important;
    }
    .calendar-container {
        background: white;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        padding: 20px;
        margin-bottom: 20px;
    }
    .dark-mode .calendar-container {
        background: #222639 !important;
        color: #e4e6eb !important;
        box-shadow: 0 10px 30px rgba(255,255,255,0.05) !important;
    }
    .intervals-container {
        background: white;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        padding: 20px;
        height: fit-content;
    }
    .dark-mode .intervals-container {
        background: #222639 !important;
        color: #e4e6eb !important;
        box-shadow: 0 10px 30px rgba(255,255,255,0.05) !important;
    }
    .details-container {
        background: white;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        padding: 20px;
        min-height: 400px;
    }
    .dark-mode .details-container {
        background: #222639 !important;
        color: #e4e6eb !important;
        box-shadow: 0 10px 30px rgba(255,255,255,0.05) !important;
    }
    .btn-modern {
        border-radius: 25px;
        padding: 10px 25px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 1px;
        transition: all 0.3s ease;
    }
    .btn-modern:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }
    .table-modern {
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 5px 15px rgba(0,0,0,0.08);
    }
    .dark-mode .table-modern {
        background: #2c3049 !important;
        color: #e4e6eb !important;
    }
    .dark-mode .table-modern th {
        background: #3d4461 !important;
        color: #e4e6eb !important;
        border-color: #4a5568 !important;
    }
    .dark-mode .table-modern td {
        background: #2c3049 !important;
        color: #e4e6eb !important;
        border-color: #4a5568 !important;
    }
    .fc-event {
        border-radius: 5px !important;
        border: none !important;
        font-weight: bold !important;
    }
    .correction-form {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 20px;
        margin-top: 15px;
    }
    .dark-mode .correction-form {
        background: #2c3049 !important;
        color: #e4e6eb !important;
    }
    .status-badge {
        padding: 8px 16px;
        border-radius: 20px;
        font-weight: 600;
        font-size: 0.85em;
    }
    .gradient-bg {
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        min-height: 100vh;
        padding: 20px;
    }
    .dark-mode .gradient-bg {
        background: linear-gradient(135deg, #1a1d2e 0%, #2c3049 100%) !important;
    }
    /* Modern Calendar Styling */
    .fc {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    .fc-header-toolbar {
        margin-bottom: 1.5rem !important;
        display: flex !important;
        justify-content: space-between !important;
        align-items: center !important;
        flex-wrap: wrap !important;
        gap: 10px !important;
        position: relative !important;
        z-index: 10 !important;
        background: transparent !important;
    }
    .fc-toolbar-chunk {
        display: flex !important;
        align-items: center !important;
        gap: 8px !important;
        position: relative !important;
        z-index: 11 !important;
    }
    .fc-button-group {
        display: flex !important;
        gap: 4px !important;
    }
    .fc-button {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
        border: none !important;
        border-radius: 8px !important;
        padding: 6px 12px !important;
        font-weight: 600 !important;
        font-size: 14px !important;
        transition: all 0.3s ease !important;
        white-space: nowrap !important;
        min-width: auto !important;
        position: relative !important;
        z-index: 12 !important;
    }
    .fc-button:hover {
        transform: translateY(-2px) !important;
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4) !important;
    }
    .fc-button:disabled {
        opacity: 0.6 !important;
        transform: none !important;
    }
    .fc-daygrid-day {
        position: relative;
        min-height: 80px !important;
        border: 1px solid #e9ecef !important;
        transition: all 0.3s ease;
    }
    .dark-mode .fc-daygrid-day {
        border: 1px solid #4a5568 !important;
        background: #2c3049 !important;
    }
    @@media (max-width: 768px) {
        .fc-daygrid-day {
            min-height: 60px !important;
        }
    }
    .fc-daygrid-day:hover {
        transform: scale(1.02);
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        z-index: 10;
    }
    .fc-daygrid-day-number {
        font-weight: bold !important;
        font-size: 14px !important;
        color: #333 !important;
        padding: 4px !important;
        z-index: 2;
        position: relative;
    }
    .dark-mode .fc-daygrid-day-number {
        color: #e4e6eb !important;
    }
    @@media (max-width: 768px) {
        .fc-daygrid-day-number {
            font-size: 12px !important;
            padding: 2px !important;
        }
    }
    .fc-day-today {
        background-color: rgba(102, 126, 234, 0.1) !important;
        border: 2px solid #667eea !important;
    }
    .attendance-status {
        position: absolute;
        bottom: 4px;
        left: 50%;
        transform: translateX(-50%);
        font-size: 9px;
        font-weight: bold;
        z-index: 10;
        padding: 3px 8px;
        border-radius: 10px;
        background: rgba(0,0,0,0.8);
        color: white;
        box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        white-space: nowrap;
        text-shadow: none;
        border: 1px solid rgba(255,255,255,0.2);
    }
    @@media (max-width: 768px) {
        .attendance-status {
            font-size: 7px !important;
            padding: 1px 4px !important;
            bottom: 2px !important;
        }
    }
    .day-present-full { 
        background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%) !important; 
        border-color: #28a745 !important;
    }
    .day-present-partial { 
        background: linear-gradient(135deg, #ffe5cc 0%, #ffb366 100%) !important; 
        border-color: #ff8c00 !important;
    }
    .day-present-partial .attendance-status {
        background: #ff8c00 !important;
        color: white !important;
        font-weight: bold !important;
        border: 1px solid rgba(255,255,255,0.3) !important;
    }
    
    .day-absent .attendance-status {
        background: #dc3545 !important;
        color: white !important;
        font-weight: bold !important;
        border: 1px solid rgba(255,255,255,0.3) !important;
    }
    
    .day-present-full .attendance-status {
        background: #28a745 !important;
        color: white !important;
        font-weight: bold !important;
        border: 1px solid rgba(255,255,255,0.3) !important;
    }
    
    .day-pending .attendance-status {
        background: #ffc107 !important;
        color: #000 !important;
        font-weight: bold !important;
        border: 1px solid rgba(0,0,0,0.2) !important;
    }
    
    .day-rejected .attendance-status {
        background: #dc3545 !important;
        color: white !important;
        font-weight: bold !important;
        border: 1px solid rgba(255,255,255,0.3) !important;
    }
    
    .day-holiday .attendance-status {
        background: #6c757d !important;
        color: white !important;
        font-weight: bold !important;
        border: 1px solid rgba(255,255,255,0.3) !important;
    }
    .day-absent { 
        background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%) !important; 
        border-color: #dc3545 !important;
    }
    .day-pending { 
        background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%) !important; 
        border-color: #ffc107 !important;
    }
    .day-rejected { 
        background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%) !important; 
        border-color: #dc3545 !important;
    }
    .day-holiday { 
        background: linear-gradient(135deg, #e2e3e5 0%, #d6d8db 100%) !important; 
        border-color: #6c757d !important;
    }
    .fc-scrollgrid {
        border-radius: 12px !important;
        overflow: hidden !important;
        box-shadow: 0 5px 15px rgba(0,0,0,0.08) !important;
    }
    .dark-mode .fc-scrollgrid {
        box-shadow: 0 5px 15px rgba(255,255,255,0.05) !important;
    }
    .fc-col-header-cell {
        background: white !important;
        color: #2c3e50 !important;
        font-weight: bold !important;
        text-transform: uppercase !important;
        font-size: 12px !important;
        letter-spacing: 0.5px !important;
        padding: 12px !important;
        border: 1px solid #dee2e6 !important;
    }
    .dark-mode .fc-col-header-cell {
        background: #3d4461 !important;
        color: #e4e6eb !important;
        border: 1px solid #4a5568 !important;
    }
    .fc-daygrid-day.fc-day-future {
        background: #f8f9fa !important;
        color: #6c757d !important;
    }
    .fc-daygrid-day.fc-day-future .fc-daygrid-day-number {
        color: #6c757d !important;
    }
    .dark-mode .fc-daygrid-day.fc-day-future {
        background: #1a1d2e !important;
        color: #6c757d !important;
    }
    .dark-mode .fc-daygrid-day.fc-day-future .fc-daygrid-day-number {
        color: #6c757d !important;
    }
    .fc-daygrid-day.fc-day-future:hover {
        transform: none !important;
        box-shadow: none !important;
    }
    
    /* Mobile responsive fixes */
    @@media (max-width: 768px) {
        .fc-header-toolbar {
            flex-direction: column !important;
            gap: 10px !important;
        }
        .fc-toolbar-chunk {
            justify-content: center !important;
        }
        .fc-button {
            font-size: 12px !important;
            padding: 4px 8px !important;
        }
        .calendar-container {
            padding: 10px !important;
        }
        .fc-daygrid-day:hover {
            transform: none !important;
            box-shadow: none !important;
        }
        .gradient-bg {
            padding: 10px !important;
        }
        .modern-card {
            padding: 15px !important;
        }
    }
    
    /* Dark mode form controls */
    .dark-mode .form-control,
    .dark-mode .form-select {
        background: #2c3049 !important;
        border-color: #4a5568 !important;
        color: #e4e6eb !important;
    }
    .dark-mode .form-control:focus,
    .dark-mode .form-select:focus {
        background: #2c3049 !important;
        border-color: #667eea !important;
        color: #e4e6eb !important;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25) !important;
    }
    
    /* Dark mode list group items */
    .dark-mode .list-group-item {
        background: #2c3049 !important;
        border-color: #4a5568 !important;
        color: #e4e6eb !important;
    }
    
    /* Dark mode badges */
    .dark-mode .badge.bg-light {
        background: #4a5568 !important;
        color: #e4e6eb !important;
    }
    
    /* Dark mode breadcrumb */
    .dark-mode .breadcrumb-item a {
        color: #667eea !important;
    }
    
    .dark-mode .breadcrumb-item.active {
        color: #e4e6eb !important;
    }
    
    /* Dark mode text colors */
    .dark-mode .text-muted {
        color: #a6adc8 !important;
    }
    
    .dark-mode .text-primary {
        color: #667eea !important;
    }
    
    /* Dark mode FullCalendar */
    .dark-mode .fc {
        color: #e4e6eb !important;
    }
    
    .dark-mode .fc-button {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
        border: none !important;
        color: white !important;
        position: relative !important;
        z-index: 12 !important;
    }
    
    .dark-mode .fc-header-toolbar {
        background: transparent !important;
        position: relative !important;
        z-index: 10 !important;
    }
    
    .dark-mode .fc-toolbar-chunk {
        position: relative !important;
        z-index: 11 !important;
    }
    
    .dark-mode .fc-col-header-cell {
        background: #3d4461 !important;
        color: #e4e6eb !important;
        border: 1px solid #4a5568 !important;
    }
    
    .dark-mode .fc-daygrid-day {
        border: 1px solid #4a5568 !important;
        background: #2c3049 !important;
    }
    
    .dark-mode .fc-daygrid-day-number {
        color: #e4e6eb !important;
    }
    
    .dark-mode .fc-daygrid-day.fc-day-future {
        background: #1a1d2e !important;
        color: #6c757d !important;
    }
    
    .dark-mode .fc-daygrid-day.fc-day-future .fc-daygrid-day-number {
        color: #6c757d !important;
    }
    
    /* Dark mode alert styles */
    .dark-mode .bg-warning {
        background: #f59e0b !important;
        color: #1a1d2e !important;
    }
    
    .dark-mode .bg-info {
        background: #3b82f6 !important;
        color: white !important;
    }
    
    .dark-mode .bg-success {
        background: #10b981 !important;
        color: white !important;
    }
    
    .dark-mode .bg-danger {
        background: #ef4444 !important;
        color: white !important;
    }
    
    /* Dark mode button styles */
    .dark-mode .btn-outline-primary {
        color: #667eea !important;
        border-color: #667eea !important;
    }
    
    .dark-mode .btn-outline-primary:hover {
        background-color: #667eea !important;
        border-color: #667eea !important;
        color: white !important;
    }
</style>

<div class="gradient-bg">
    <div class="container">
        <!-- Header Section -->
        <div class="modern-card">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1 class="mb-0"><i class="fas fa-calendar-alt me-3"></i>Attendance Management</h1>
                    <p class="mb-0 mt-2 opacity-75">Track and manage employee attendance efficiently</p>
                </div>
                <div class="col-md-4 text-end">
                    @if (todayIntervals != null && todayIntervals.Any()) {
                        var totalLogins = todayIntervals.Count;
                        var totalLogouts = todayIntervals.Count(i => i.Item2.HasValue);
                        double totalHours = 0;
                        foreach (var interval in todayIntervals) {
                            if (interval.Item2.HasValue) {
                                totalHours += (interval.Item2.Value - interval.Item1).TotalHours;
                            }
                        }
                        <div class="d-flex justify-content-end gap-2">
                            <span class="badge bg-light text-dark px-3 py-2">
                                <i class="fas fa-sign-in-alt me-1"></i>@totalLogins Logins
                            </span>
                            <span class="badge bg-light text-dark px-3 py-2">
                                <i class="fas fa-sign-out-alt me-1"></i>@totalLogouts Logouts
                            </span>
                            <span class="badge bg-warning text-dark px-3 py-2">
                                <i class="fas fa-clock me-1"></i>@totalHours.ToString("0.##")h
                            </span>
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- Admin/Partner Controls -->
        @if (canManageAttendance) {
            <div class="stats-card">
                <div class="row align-items-center">
                    <div class="col-md-3">
                        <label class="form-label fw-bold"><i class="fas fa-users me-2"></i>Select Employee:</label>
                    </div>
                    <div class="col-md-9">
                        <select id="agentSelect" class="form-select">
                            @if (ViewBag.AllUsers != null)
                            {
                                foreach (var user in (List<CRM.Models.UserModel>)ViewBag.AllUsers)
                                {
                                    var selected = user.UserId == agentId ? "selected=\"selected\"" : "";
                                    @:<option value="@user.UserId" @selected>@user.Username (@user.Email)</option>
                                }
                            }
                        </select>
                    </div>
                </div>
            </div>
        }

        <!-- Main Content -->
        <div class="row">
            <!-- Calendar Section -->
            <div class="col-lg-7 col-md-12">
                <div class="calendar-container">
                    <div id="calendar"></div>
                </div>
            </div>

            <!-- Today's Intervals Section -->
            <div class="col-lg-5">
                <div class="intervals-container" id="intervalsContainer">
                    @if (todayIntervals != null && todayIntervals.Count > 0)
                    {
                        <h5 class="text-center mb-4" id="intervalsTitle">
                            <i class="fas fa-business-time text-primary me-2"></i>Today's Login/Logout Intervals
                        </h5>
                        <div class="table-responsive">
                            <table class="table table-modern table-striped">
                                <thead>
                                    <tr>
                                        <th class="text-center">#</th>
                                        <th class="text-center">Login Time</th>
                                        <th class="text-center">Logout Time</th>
                                        <th class="text-center">Duration</th>
                                    </tr>
                                </thead>
                                <tbody>
                                @for (int i = 0; i < todayIntervals.Count; i++)
                                {
                                    var duration = todayIntervals[i].Item2.HasValue ? 
                                        (todayIntervals[i].Item2.Value - todayIntervals[i].Item1).TotalMinutes.ToString("0") + "m" : 
                                        "Active";
                                    <tr>
                                        <td class="text-center fw-bold">@(i + 1)</td>
                                        <td class="text-center text-success fw-bold">
                                            @todayIntervals[i].Item1.ToString("HH:mm:ss")
                                        </td>
                                        <td class="text-center @(todayIntervals[i].Item2.HasValue ? "text-danger" : "text-warning") fw-bold">
                                            @if (todayIntervals[i].Item2.HasValue)
                                            {
                                                @todayIntervals[i].Item2.Value.ToString("HH:mm:ss")
                                            }
                                            else
                                            {
                                                <span>Active</span>
                                            }
                                        </td>
                                        <td class="text-center">
                                            <span class="badge bg-light text-dark px-3 py-2">
                                                @duration
                                            </span>
                                        </td>
                                    </tr>
                                }
                                </tbody>
                            </table>
                        </div>
                        
                        @if (!canManageAttendance || (canManageAttendance && agentId.ToString() == User.Identity.Name))
                        {
                            <div class="text-center mt-4">
                                @if (hasActiveSession)
                                {
                                    <form method="post" action="/Attendance/Logout" class="d-inline">
                                        <input type="hidden" name="agentId" value="@agentId" />
                                        <input type="hidden" name="attendanceId" value="@(todayAttendance?.AttendanceId ?? 0)" />
                                        <input type="hidden" name="date" value="@DateTime.Today.ToString("yyyy-MM-dd")" />
                                        <button type="submit" class="btn btn-danger btn-modern">
                                            <i class="fas fa-sign-out-alt me-2"></i>Logout
                                        </button>
                                    </form>
                                }
                                else
                                {
                                    <form method="post" action="/Attendance/Login" class="d-inline">
                                        <input type="hidden" name="agentId" value="@agentId" />
                                        <input type="hidden" name="attendanceId" value="@(todayAttendance?.AttendanceId ?? 0)" />
                                        <input type="hidden" name="date" value="@DateTime.Today.ToString("yyyy-MM-dd")" />
                                        <button type="submit" class="btn btn-success btn-modern">
                                            <i class="fas fa-sign-in-alt me-2"></i>Login
                                        </button>
                                    </form>
                                }
                            </div>
                        }
                    }
                    else
                    {
                        <div class="text-center py-5">
                            <i class="fas fa-calendar-times text-muted" style="font-size: 3rem;"></i>
                            <h5 class="text-muted mt-3">No login records for today</h5>
                            @if (!canManageAttendance || (canManageAttendance && agentId.ToString() == User.Identity.Name))
                            {
                                <form method="post" action="/Attendance/Login" class="mt-3">
                                    <input type="hidden" name="agentId" value="@agentId" />
                                    <input type="hidden" name="attendanceId" value="@(todayAttendance?.AttendanceId ?? 0)" />
                                    <input type="hidden" name="date" value="@DateTime.Today.ToString("yyyy-MM-dd")" />
                                    <button type="submit" class="btn btn-success btn-modern">
                                        <i class="fas fa-sign-in-alt me-2"></i>Start Your Day
                                    </button>
                                </form>
                            }
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- Details and Admin Section -->
        <div class="row mt-4">
            <div class="col-lg-8">
                <div class="details-container">
                    <div id="attendanceDetails" class="text-center py-5">
                        <i class="fas fa-mouse-pointer text-muted mb-3" style="font-size: 3rem;"></i>
                        <h5 class="text-muted">Click on a calendar date to view details</h5>
                    </div>
                </div>
            </div>

            @if (canManageAttendance) {
                <div class="col-lg-4">
                    <div class="details-container">
                        <h5 class="mb-4">
                            <i class="fas fa-exclamation-triangle text-warning me-2"></i>Pending Requests
                        </h5>
                        @if (attendance.Any(a => a.CorrectionRequested && a.CorrectionStatus == "Pending" && a.Date.Date != DateTime.Today))
                        {
                            <div class="list-group">
                                @foreach (var record in attendance.Where(a => a.CorrectionRequested && a.CorrectionStatus == "Pending" && a.Date.Date != DateTime.Today))
                                {
                                    <div class="list-group-item border-0 mb-3 rounded shadow-sm">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div>
                                                <h6 class="mb-1">
                                                    <i class="fas fa-calendar-day text-primary me-2"></i>@record.Date.ToString("MMM dd, yyyy")
                                                </h6>
                                                <p class="mb-2 text-muted">@(string.IsNullOrEmpty(record.CorrectionReason) ? "No reason provided" : record.CorrectionReason)</p>
                                            </div>
                                        </div>
                                        <div class="d-flex gap-2 mt-2">
                                            <button class="btn btn-success btn-sm approveCorrection" data-id="@record.AttendanceId">
                                                <i class="fas fa-check me-1"></i>Approve
                                            </button>
                                            <button class="btn btn-danger btn-sm rejectCorrection" data-id="@record.AttendanceId">
                                                <i class="fas fa-times me-1"></i>Reject
                                            </button>
                                        </div>
                                    </div>
                                }
                            </div>
                        }
                        else
                        {
                            <div class="text-center py-4">
                                <i class="fas fa-check-circle text-success" style="font-size: 2rem;"></i>
                                <p class="text-muted mt-2">No pending requests</p>
                            </div>
                        }
                    </div>
                </div>
            }
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    var calendarEl = document.getElementById('calendar');
    var isInitialLoad = true;
    var calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        initialDate: new Date(@ViewBag.Year, @ViewBag.Month - 1, 1),
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,dayGridWeek'
        },
        height: 'auto',
        datesSet: function(dateInfo) {
            // Skip redirect on initial load
            if (isInitialLoad) {
                isInitialLoad = false;
                return;
            }
            
            // Reload page when month changes to get fresh data from server
            var currentDate = dateInfo.view.currentStart;
            var year = currentDate.getFullYear();
            var month = currentDate.getMonth() + 1;
            var urlParams = new URLSearchParams(window.location.search);
            var agentId = urlParams.get('agentId') || '@ViewBag.AgentId';
            
            // Redirect to new month
            window.location.href = '/Attendance/Calendar?agentId=' + agentId + '&year=' + year + '&month=' + month;
        },
        dayCellDidMount: function(info) {
            var dateStr = info.date.getFullYear() + '-' + 
                String(info.date.getMonth() + 1).padStart(2, '0') + '-' + 
                String(info.date.getDate()).padStart(2, '0');
            var todayDate = new Date();
            var today = todayDate.getFullYear() + '-' + 
                String(todayDate.getMonth() + 1).padStart(2, '0') + '-' + 
                String(todayDate.getDate()).padStart(2, '0');
            var isToday = dateStr === today;
            var isFuture = dateStr > today;
            // Check last activity from AttendanceLog table only for today
            var lastActivityIsLogin = @Html.Raw(Json.Serialize(ViewBag.LastActivityIsLogin ?? false));
            
            var attendanceRecord = @Html.Raw(Json.Serialize(
                attendance.ToDictionary(a => a.Date.ToString("yyyy-MM-dd"), a => new {
                    status = a.Status ?? "Absent",
                    hours = a.LoginTime != null && a.LogoutTime != null ? 
                        (a.LogoutTime.Value - a.LoginTime.Value).TotalHours : 0,
                    correctionStatus = a.CorrectionStatus ?? "",
                    correctionRequested = a.CorrectionRequested,
                    hasLogin = a.LoginTime != null,
                    hasLogout = a.LogoutTime != null,
                    attendanceId = a.AttendanceId
                })
            ));
            
            console.log('Attendance Records:', attendanceRecord);
            
            // Handle future dates - always grey
            if (isFuture) {
                return; // No styling for future dates
            }
            
            // Handle today with active session (last activity is Login)
            if (isToday && lastActivityIsLogin) {
                console.log('Today with active session - applying orange');
                info.el.classList.add('day-present-partial');
                var statusElement = document.createElement('div');
                statusElement.className = 'attendance-status';
                statusElement.textContent = 'Present';
                info.el.appendChild(statusElement);
                return;
            }
            
            // Don't show any status for today if no records exist (empty tables)
            if (isToday && !attendanceRecord[dateStr]) {
                return; // No styling for today when no records
            }
            
            if (attendanceRecord[dateStr]) {
                var data = attendanceRecord[dateStr];
                var statusText = '';
                var className = '';
                
                console.log('Processing date:', dateStr, 'Data:', data, 'isToday:', isToday, 'lastActivityIsLogin:', lastActivityIsLogin);
                
                if (data.correctionStatus === 'Rejected') {
                    className = 'day-rejected';
                    statusText = 'Rejected';
                } else if (data.correctionRequested && data.correctionStatus === 'Pending') {
                    className = 'day-pending';
                    statusText = 'Pending';
                } else if (data.status === 'Present') {
                    if (data.hours >= 9) {
                        className = 'day-present-full';
                        statusText = 'P';
                    } else {
                        className = 'day-present-partial';
                        statusText = 'Present';
                    }
                } else if (data.status === 'Absent') {
                    className = 'day-absent';
                    statusText = 'Absent';
                } else if (data.status === 'Holiday') {
                    className = 'day-holiday';
                    statusText = 'Holiday';
                } else if (data.hasLogin && !data.hasLogout && !isToday) {
                    // Only apply partial for past dates with login but no logout
                    className = 'day-present-partial';
                    statusText = 'Present';
                }
                
                if (className) {
                    info.el.classList.add(className);
                }
                
                var existingStatus = info.el.querySelector('.attendance-status');
                if (existingStatus) {
                    existingStatus.remove();
                }
                
                if (statusText) {
                    var statusElement = document.createElement('div');
                    statusElement.className = 'attendance-status';
                    statusElement.textContent = statusText;
                    info.el.appendChild(statusElement);
                }
            } else {
                // No record found - show as absent for past dates
                if (!isFuture) {
                    info.el.classList.add('day-absent');
                    var statusElement = document.createElement('div');
                    statusElement.className = 'attendance-status';
                    statusElement.textContent = 'Absent';
                    info.el.appendChild(statusElement);
                }
            }
        },
        events: [],

        dateClick: function(info) {
            var dateStr = info.dateStr;
            
            // Update intervals section with clicked date's data
            updateIntervalsSection(dateStr);
            
            var attendanceRecord = @Html.Raw(Json.Serialize(
                attendance.ToDictionary(a => a.Date.ToString("yyyy-MM-dd"), a => new {
                    status = a.Status ?? "Absent",
                    login = a.LoginTime?.ToString("HH:mm"),
                    logout = a.LogoutTime?.ToString("HH:mm"),
                    hours = a.LoginTime != null && a.LogoutTime != null ? 
                        (a.LogoutTime.Value - a.LoginTime.Value).TotalHours.ToString("0.##") : "0",
                    correction = a.CorrectionRequested ? (a.CorrectionStatus ?? "Pending") : null,
                    correctionReason = a.CorrectionReason ?? "",
                    attendanceId = a.AttendanceId,
                    hasLoginNoLogout = a.LoginTime != null && a.LogoutTime == null,
                    hasLogin = a.LoginTime != null,
                    hasLogout = a.LogoutTime != null
                })
            ));
            
            var todayDate = new Date();
            var todayStr = todayDate.getFullYear() + '-' + 
                String(todayDate.getMonth() + 1).padStart(2, '0') + '-' + 
                String(todayDate.getDate()).padStart(2, '0');
            var isToday = dateStr === todayStr;
            var html = '';
            
            // Get today's total hours from the header if it's today
            var todayTotalHours = '@(todayIntervals != null && todayIntervals.Any() ? todayIntervals.Where(i => i.Item2.HasValue).Sum(i => (i.Item2.Value - i.Item1).TotalHours).ToString("0.##") : "0")';
            var displayHours = isToday ? todayTotalHours : (attendanceRecord[dateStr] ? attendanceRecord[dateStr].hours : '-');
            
            if (attendanceRecord[dateStr]) {
                var data = attendanceRecord[dateStr];
                
                html = `
                    <div class="text-center mb-3">
                        <h5 class="text-muted mb-0">${new Date(dateStr).toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' })}</h5>
                    </div>
                    <div class="bg-white rounded shadow-sm p-4">
                        <div class="row">
                            <div class="col-6 text-center border-end">
                                <p class="text-muted mb-1 small">Total Duration</p>
                                <h2 class="text-primary mb-0 fw-bold">${displayHours}h</h2>
                            </div>
                            <div class="col-6 text-center">
                                <p class="text-muted mb-1 small">Status</p>
                                <span class="badge bg-${data.status === 'Present' ? 'success' : data.status === 'Absent' ? 'danger' : 'secondary'} px-3 py-2">${data.status}</span>
                            </div>
                        </div>`;
                
                // Show correction status or form for incomplete records (0 hours, -h, or login without logout) - but not for today
                var showCorrectionOption = !isToday && (data.hasLoginNoLogout || displayHours === '0' || displayHours === '-' || (data.hasLogin && data.hours === '-'));
                
                if (showCorrectionOption) {
                    if (data.correction) {
                        // Show correction status
                        var statusClass = data.correction === 'Approved' ? 'success' : 
                                        data.correction === 'Rejected' ? 'danger' : 'warning';
                        var statusIcon = data.correction === 'Approved' ? 'check-circle' : 
                                       data.correction === 'Rejected' ? 'times-circle' : 'clock';
                        html += `
                            <div class="mt-3 p-3 bg-${statusClass} bg-opacity-10 border border-${statusClass} rounded">
                                <div class="d-flex align-items-center mb-2">
                                    <i class="fas fa-${statusIcon} text-${statusClass} me-2"></i>
                                    <h6 class="mb-0 text-${statusClass}">Correction Request ${data.correction}</h6>
                                </div>
                                <p class="mb-0 small text-muted">
                                    <strong>Reason:</strong> ${data.correctionReason || 'No reason provided'}
                                </p>
                            </div>`;
                    } else {
                        // Show correction form for incomplete records (role-based)
                        var warningText = data.hasLoginNoLogout ? 'Incomplete Record - Missing Logout' : 
                                        (displayHours === '-' || data.hours === '-') ? 'Incomplete Record - No Hours Logged' : 'Incomplete Record - 0 Hours';
                        
                        var canManageAttendance = @Html.Raw(Json.Serialize(canManageAttendance));
                        
                        if (!canManageAttendance) {
                            // Show correction form for Sales/Agents
                            html += `
                                <div class="mt-3 p-3 bg-warning bg-opacity-10 border border-warning rounded">
                                    <p class="text-warning mb-2 small fw-bold"><i class="fas fa-exclamation-triangle me-1"></i>${warningText}</p>
                                    <form id="correctionForm">
                                        <input type="hidden" name="attendanceId" value="${data.attendanceId || 0}" />
                                        <input type="hidden" name="agentId" value="@ViewBag.AgentId" />
                                        <input type="hidden" name="date" value="${dateStr}" />
                                        <textarea name="reason" class="form-control mb-2" rows="2" placeholder="Reason for correction (e.g., forgot to logout, system error)..." required></textarea>
                                        <button type="submit" class="btn btn-warning btn-sm">
                                            <i class="fas fa-paper-plane me-1"></i>Submit Request
                                        </button>
                                    </form>
                                </div>`;
                        } else {
                            // Show admin actions for pending requests
                            if (data.correction === 'Pending') {
                                html += `
                                    <div class="mt-3 p-3 bg-warning bg-opacity-10 border border-warning rounded">
                                        <p class="text-warning mb-2 small fw-bold"><i class="fas fa-exclamation-triangle me-1"></i>Correction Request Pending</p>
                                        <p class="text-muted mb-2 small"><strong>Reason:</strong> ${data.correctionReason}</p>
                                        <div class="d-flex gap-2">
                                            <button class="btn btn-success btn-sm approveCorrection" data-id="${data.attendanceId}">
                                                <i class="fas fa-check me-1"></i>Approve (9 hours)
                                            </button>
                                            <button class="btn btn-danger btn-sm rejectCorrection" data-id="${data.attendanceId}">
                                                <i class="fas fa-times me-1"></i>Reject
                                            </button>
                                        </div>
                                    </div>`;
                            } else {
                                html += `
                                    <div class="mt-3 p-3 bg-info bg-opacity-10 border border-info rounded">
                                        <p class="text-info mb-0 small fw-bold"><i class="fas fa-info-circle me-1"></i>${warningText}</p>
                                        <p class="text-muted mb-0 small mt-1">Admin view - correction requests can be made by the user</p>
                                    </div>`;
                            }
                        }
                    }
                }
                
                html += `
                    </div>`;
            } else {
                html = `
                    <div class="text-center py-4">
                        <h5 class="text-muted mb-2">${new Date(dateStr).toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' })}</h5>
                        <div class="bg-white rounded shadow-sm p-4">
                            <i class="fas fa-calendar-times text-muted mb-2" style="font-size: 2rem;"></i>
                            <p class="text-muted mb-0 small">No attendance record found</p>
                        </div>
                    </div>`;
            }
            
            document.getElementById('attendanceDetails').innerHTML = html;
        }
    });
    
    calendar.render();
    
    // Function to update intervals section based on selected date
    function updateIntervalsSection(dateStr) {
        var agentId = '@ViewBag.AgentId';
        var canManageAttendance = @Html.Raw(Json.Serialize(canManageAttendance));
        
        $.ajax({
            url: '/Attendance/GetDateIntervals',
            type: 'GET',
            data: { agentId: agentId, date: dateStr },
            success: function(response) {
                var container = $('#intervalsContainer');
                var selectedDate = new Date(dateStr);
                var today = new Date();
                var isToday = selectedDate.toDateString() === today.toDateString();
                var dateTitle = isToday ? "Today's" : selectedDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                var hasActiveSession = response.hasActiveSession;
                var attendanceId = response.attendanceId || 0;
                
                if (response.intervals && response.intervals.length > 0) {
                    var html = `
                        <h5 class="text-center mb-4">
                            <i class="fas fa-business-time text-primary me-2"></i>${dateTitle} Login/Logout Intervals
                        </h5>
                        <div class="table-responsive">
                            <table class="table table-modern table-striped">
                                <thead>
                                    <tr>
                                        <th class="text-center">#</th>
                                        <th class="text-center">Login Time</th>
                                        <th class="text-center">Logout Time</th>
                                        <th class="text-center">Duration</th>
                                    </tr>
                                </thead>
                                <tbody>`;
                    
                    response.intervals.forEach(function(interval, index) {
                        html += `
                            <tr>
                                <td class="text-center fw-bold">${index + 1}</td>
                                <td class="text-center text-success fw-bold">${interval.login}</td>
                                <td class="text-center ${interval.logout ? 'text-danger' : 'text-warning'} fw-bold">
                                    ${interval.logout || '<span>Active</span>'}
                                </td>
                                <td class="text-center">
                                    <span class="badge bg-light text-dark px-3 py-2">${interval.duration}</span>
                                </td>
                            </tr>`;
                    });
                    
                    html += `</tbody></table></div>`;
                    
                    // Add login/logout buttons only for today
                    if (isToday && (!canManageAttendance || (canManageAttendance && agentId.toString() === '@User.Identity.Name'))) {
                        html += `<div class="text-center mt-4">`;
                        if (hasActiveSession) {
                            html += `
                                <form method="post" action="/Attendance/Logout" class="d-inline">
                                    <input type="hidden" name="agentId" value="${agentId}" />
                                    <input type="hidden" name="attendanceId" value="${attendanceId}" />
                                    <input type="hidden" name="date" value="${dateStr}" />
                                    <button type="submit" class="btn btn-danger btn-modern">
                                        <i class="fas fa-sign-out-alt me-2"></i>Logout
                                    </button>
                                </form>`;
                        } else {
                            html += `
                                <form method="post" action="/Attendance/Login" class="d-inline">
                                    <input type="hidden" name="agentId" value="${agentId}" />
                                    <input type="hidden" name="attendanceId" value="${attendanceId}" />
                                    <input type="hidden" name="date" value="${dateStr}" />
                                    <button type="submit" class="btn btn-success btn-modern">
                                        <i class="fas fa-sign-in-alt me-2"></i>Login
                                    </button>
                                </form>`;
                        }
                        html += `</div>`;
                    }
                    
                    container.html(html);
                } else {
                    var html = `
                        <div class="text-center py-5">
                            <i class="fas fa-calendar-times text-muted" style="font-size: 3rem;"></i>
                            <h5 class="text-muted mt-3">No login records for ${dateTitle}</h5>`;
                    
                    // Add login button for today if no records
                    if (isToday && (!canManageAttendance || (canManageAttendance && agentId.toString() === '@User.Identity.Name'))) {
                        html += `
                            <form method="post" action="/Attendance/Login" class="mt-3">
                                <input type="hidden" name="agentId" value="${agentId}" />
                                <input type="hidden" name="attendanceId" value="${attendanceId}" />
                                <input type="hidden" name="date" value="${dateStr}" />
                                <button type="submit" class="btn btn-success btn-modern">
                                    <i class="fas fa-sign-in-alt me-2"></i>Start Your Day
                                </button>
                            </form>`;
                    }
                    
                    html += `</div>`;
                    container.html(html);
                }
            }
        });
    }
    
    // Auto-select today if viewing current month
    var viewingYear = @ViewBag.Year;
    var viewingMonth = @ViewBag.Month;
    var todayDate = new Date();
    var isCurrentMonth = (todayDate.getFullYear() === viewingYear && (todayDate.getMonth() + 1) === viewingMonth);
    
    if (isCurrentMonth) {
        var todayStr = todayDate.getFullYear() + '-' + 
            String(todayDate.getMonth() + 1).padStart(2, '0') + '-' + 
            String(todayDate.getDate()).padStart(2, '0');
        setTimeout(() => {
            calendar.trigger('dateClick', { dateStr: todayStr });
        }, 500);
    }

    // Agent dropdown change
    $('#agentSelect').on('change', function() {
        var agentId = $(this).val();
        window.location.href = '/Attendance/Calendar?agentId=' + agentId;
    });

    // Form submissions
    $(document).on('submit', '#correctionForm', function(e) {
        e.preventDefault();
        var form = $(this);
        console.log('Submitting correction form:', form.serialize());
        
        $.post('/Attendance/RequestCorrection', form.serialize())
            .done(function(response) {
                console.log('Correction request response:', response);
                if (typeof Swal !== 'undefined') {
                    Swal.fire('Success!', 'Correction request submitted successfully!', 'success')
                        .then(() => location.reload());
                } else {
                    alert('Correction request submitted successfully!');
                    location.reload();
                }
            })
            .fail(function(xhr, status, error) {
                console.error('Correction request failed:', xhr.responseText);
                if (typeof Swal !== 'undefined') {
                    Swal.fire('Error!', 'Failed to submit request. Please try again.', 'error');
                } else {
                    alert('Failed to submit request. Please try again.');
                }
            });
    });

    $(document).on('click', '.approveCorrection', function() {
        var id = $(this).data('id');
        console.log('Approving correction for ID:', id);
        
        if (typeof Swal !== 'undefined') {
            Swal.fire({
                title: 'Approve Request?',
                text: 'This will set 9 hours for this day.',
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Yes, approve it!'
            }).then((result) => {
                if (result.isConfirmed) {
                    $.post('/Attendance/ApproveCorrection', { attendanceId: id })
                        .done(function() {
                            Swal.fire('Approved!', 'Request has been approved.', 'success')
                                .then(() => location.reload());
                        })
                        .fail(function() {
                            Swal.fire('Error!', 'Failed to approve request.', 'error');
                        });
                }
            });
        } else {
            if (confirm('Approve this request? This will set 9 hours for this day.')) {
                $.post('/Attendance/ApproveCorrection', { attendanceId: id })
                    .done(function() {
                        alert('Request has been approved.');
                        location.reload();
                    })
                    .fail(function() {
                        alert('Failed to approve request.');
                    });
            }
        }
    });

    $(document).on('click', '.rejectCorrection', function() {
        var id = $(this).data('id');
        console.log('Rejecting correction for ID:', id);
        
        if (typeof Swal !== 'undefined') {
            Swal.fire({
                title: 'Reject Request?',
                text: 'This action cannot be undone.',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Yes, reject it!'
            }).then((result) => {
                if (result.isConfirmed) {
                    $.post('/Attendance/RejectCorrection', { attendanceId: id })
                        .done(function() {
                            Swal.fire('Rejected!', 'Request has been rejected.', 'success')
                                .then(() => location.reload());
                        })
                        .fail(function() {
                            Swal.fire('Error!', 'Failed to reject request.', 'error');
                        });
                }
            });
        } else {
            if (confirm('Reject this request? This action cannot be undone.')) {
                $.post('/Attendance/RejectCorrection', { attendanceId: id })
                    .done(function() {
                        alert('Request has been rejected.');
                        location.reload();
                    })
                    .fail(function() {
                        alert('Failed to reject request.');
                    });
            }
        }
    });
});
</script>

<!-- SweetAlert2 for better notifications -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>