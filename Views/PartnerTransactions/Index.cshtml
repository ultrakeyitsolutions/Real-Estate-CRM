@model List<dynamic>
@{
    ViewData["Title"] = "My Transactions";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<style>
    .transaction-card {
        background: var(--bs-body-bg, white);
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1rem;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        border: 1px solid var(--bs-border-color, rgba(0, 0, 0, 0.05));
        transition: all 0.3s ease;
    }

    .transaction-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    }

    .transaction-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 1rem;
        gap: 1rem;
    }

    .transaction-id {
        font-weight: 600;
        color: var(--bs-body-color, #1e293b);
        font-size: 1.1rem;
        word-break: break-all;
        max-width: 300px;
    }

    /* Mobile responsive styles */
    @@media (max-width: 768px) {
        .transaction-card {
            padding: 0.75rem;
            margin-bottom: 0.75rem;
        }
        
        .transaction-card .d-flex {
            flex-direction: column;
            align-items: flex-start !important;
            gap: 0.5rem;
        }
        
        .transaction-card .d-flex:first-child {
            width: 100%;
            margin-bottom: 0;
        }
        
        .transaction-card .d-flex:last-child {
            width: 100%;
            justify-content: space-between;
            align-items: center;
            margin-top: 0.25rem;
        }
        
        .transaction-id {
            font-size: 0.85rem;
            max-width: 100%;
            margin-bottom: 0.25rem;
            line-height: 1.2;
        }
        
        .transaction-amount {
            font-size: 1.1rem;
        }
        
        .stats-grid {
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }
        
        .stats-card {
            padding: 1rem;
        }
        
        .stats-number {
            font-size: 1.5rem;
        }
        
        .header-section {
            padding: 1.25rem;
        }
        
        .header-section h1 {
            font-size: 1.75rem !important;
        }
        
        .filter-section {
            padding: 1.25rem;
        }
    }
    
    @@media (max-width: 576px) {
        .stats-grid {
            grid-template-columns: 1fr;
            gap: 0.75rem;
        }
        
        .transaction-card {
            padding: 0.5rem;
            margin-bottom: 0.5rem;
        }
        
        .transaction-id {
            font-size: 0.8rem;
            line-height: 1.1;
        }
        
        .transaction-amount {
            font-size: 1rem;
        }
        
        .status-badge {
            font-size: 0.65rem;
            padding: 0.2rem 0.4rem;
        }
        
        .stats-card {
            padding: 0.75rem;
        }
        
        .header-section {
            padding: 1rem;
        }
        
        .filter-section {
            padding: 1rem;
        }
    }

    /* Dark mode support */
    [data-bs-theme="dark"] .transaction-id,
    .dark-mode .transaction-id {
        color: #ffffff !important;
    }
    
    [data-bs-theme="dark"] .text-muted,
    .dark-mode .text-muted {
        color: #d1d5db !important;
    }
    
    [data-bs-theme="dark"] .transaction-amount,
    .dark-mode .transaction-amount {
        color: inherit !important;
    }
    
    [data-bs-theme="dark"] .amount-captured,
    .dark-mode .amount-captured { 
        color: #10b981 !important; 
    }
    
    [data-bs-theme="dark"] .amount-refunded,
    .dark-mode .amount-refunded { 
        color: #f59e0b !important; 
    }
    
    [data-bs-theme="dark"] .amount-failed,
    .dark-mode .amount-failed { 
        color: #ef4444 !important; 
    }
    
    [data-bs-theme="dark"] .stats-number,
    .dark-mode .stats-number {
        color: #ffffff !important;
    }
    
    [data-bs-theme="dark"] .stats-label,
    .dark-mode .stats-label {
        color: #d1d5db !important;
    }
    
    [data-bs-theme="dark"] .status-badge.status-captured,
    .dark-mode .status-badge.status-captured { 
        background: #10b981 !important; 
        color: white !important; 
    }
    
    [data-bs-theme="dark"] .status-badge.status-failed,
    .dark-mode .status-badge.status-failed { 
        background: #ef4444 !important; 
        color: white !important; 
    }
    
    [data-bs-theme="dark"] .status-badge.status-refunded,
    .dark-mode .status-badge.status-refunded { 
        background: #f59e0b !important; 
        color: white !important; 
    }
    
    [data-bs-theme="dark"] .status-badge.status-authorized,
    .dark-mode .status-badge.status-authorized { 
        background: #eab308 !important; 
        color: white !important; 
    }
    
    [data-bs-theme="dark"] .status-badge.status-created,
    .dark-mode .status-badge.status-created { 
        background: #6b7280 !important; 
        color: white !important; 
    }

    .transaction-amount {
        font-size: 1.5rem;
        font-weight: 700;
        white-space: nowrap;
    }

    .amount-captured { color: #059669; }
    .amount-refunded { color: #f97316; }
    .amount-failed { color: #dc2626; }

    .status-badge {
        padding: 0.375rem 0.75rem;
        border-radius: 20px;
        font-weight: 600;
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .dark-mode .transaction-card .status-badge.status-captured { background: #10b981 !important; color: white !important; }
    .dark-mode .transaction-card .status-badge.status-failed { background: #ef4444 !important; color: white !important; }
    .dark-mode .transaction-card .status-badge.status-refunded { background: #f59e0b !important; color: white !important; }
    .dark-mode .transaction-card .status-badge.status-processed { background: #f59e0b !important; color: white !important; }
    .dark-mode .transaction-card .status-badge.status-authorized { background: #eab308 !important; color: white !important; }
    .dark-mode .transaction-card .status-badge.status-created { background: #6b7280 !important; color: white !important; }
    
    .status-captured { background: #22c55e !important; color: white !important; }
    .status-failed { background: #ef4444 !important; color: white !important; }
    .status-refunded { background: #f97316 !important; color: white !important; }
    .status-processed { background: #f97316 !important; color: white !important; }
    .status-authorized { background: #eab308 !important; color: white !important; }
    .status-created { background: #6b7280 !important; color: white !important; }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .stats-card {
        background: var(--bs-body-bg, white);
        border-radius: 12px;
        padding: 1.5rem;
        text-align: center;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        border: 1px solid var(--bs-border-color, rgba(0, 0, 0, 0.05));
    }

    .stats-number {
        font-size: 2rem;
        font-weight: 800;
        color: var(--bs-body-color, #1e293b);
        margin-bottom: 0.5rem;
    }

    .stats-label {
        font-size: 0.875rem;
        color: var(--bs-secondary-color, #64748b);
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .header-section {
        background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
        color: white;
        padding: 2rem;
        border-radius: 16px;
        margin-bottom: 2rem;
    }

    .filter-section {
        background: var(--bs-body-bg, white);
        border-radius: 16px;
        padding: 2rem;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        margin-bottom: 2rem;
        border: 1px solid var(--bs-border-color, transparent);
    }
</style>

<div class="content">
    <!-- Breadcrumb -->
    <nav class="mb-3" aria-label="breadcrumb">
        <ol class="breadcrumb mb-0">
            <li class="breadcrumb-item"><a href="/Partner/Dashboard">Dashboard</a></li>
            <li class="breadcrumb-item active">My Transactions</li>
        </ol>
    </nav>

    <!-- Header Section -->
    <div class="header-section">
        <div class="row align-items-center">
            <div class="col-lg-8">
                <div class="d-flex align-items-center mb-3">
                    <div class="me-3">
                        <i class="fa-solid fa-credit-card" style="font-size: 2.5rem; opacity: 0.9;"></i>
                    </div>
                    <div>
                        <h1 class="mb-0" style="font-size: 2.5rem; font-weight: 700;">My Transactions</h1>
                        <p class="mb-0" style="font-size: 1.1rem; opacity: 0.9;">
                            Your payment transactions from Razorpay
                        </p>
                        @if (ViewBag.PartnerUserId != null)
                        {
                            <small style="opacity: 0.8;">Partner ID: @ViewBag.PartnerUserId</small>
                        }
                    </div>
                </div>
            </div>
            <div class="col-lg-4 text-lg-end">
                <a href="/PartnerTransactions/ExportTransactions?format=csv&status=@ViewBag.Status&method=@ViewBag.Method&fromDate=@ViewBag.FromDate&toDate=@ViewBag.ToDate" class="btn btn-light">
                    <i class="fa-solid fa-download me-1"></i>Export CSV
                </a>
            </div>
        </div>
    </div>

    @if (ViewBag.Error != null)
    {
        <div class="alert alert-danger">
            <i class="fas fa-exclamation-triangle me-2"></i>
            @ViewBag.Error
        </div>
    }
    
    @if (ViewBag.Debug != null)
    {
        <div class="alert alert-info">
            <strong>Info:</strong> @ViewBag.Debug
        </div>
    }

    <!-- Statistics -->
    <div class="stats-grid">
        <div class="stats-card">
            <div class="stats-number">@(Model?.Count ?? 0)</div>
            <div class="stats-label">Total Transactions</div>
        </div>
        <div class="stats-card">
            <div class="stats-number">@(Model?.Count(p => p.status == "captured") ?? 0)</div>
            <div class="stats-label">Successful</div>
        </div>
        <div class="stats-card">
            @{
                var totalAmount = Model?.Sum(p => (long)p.amount) / 100m ?? 0;
            }
            <div class="stats-number">₹@totalAmount.ToString("N0")</div>
            <div class="stats-label">Total Amount</div>
        </div>
        <div class="stats-card">
            @{
                var successAmount = Model?.Where(p => p.status == "captured").Sum(p => (long)p.amount) / 100m ?? 0;
            }
            <div class="stats-number">₹@successAmount.ToString("N0")</div>
            <div class="stats-label">Successful Amount</div>
        </div>
    </div>

    <!-- Filter Section -->
    <div class="filter-section">
        <form method="get" action="/PartnerTransactions/Index">
            <div class="row g-3">
                <div class="col-md-3">
                    <label class="form-label fw-semibold">Status</label>
                    @{
                        var statusValue = ViewBag.Status?.ToString() ?? "";
                    }
                    <select name="status" class="form-select">
                        <option value="">All Status</option>
                        <option value="captured" selected="@(statusValue == "captured")">Captured</option>
                        <option value="failed" selected="@(statusValue == "failed")">Failed</option>
                        <option value="authorized" selected="@(statusValue == "authorized")">Authorized</option>
                        <option value="refunded" selected="@(statusValue == "refunded")">Refunded</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label fw-semibold">Payment Method</label>
                    @{
                        var methodValue = ViewBag.Method?.ToString() ?? "";
                    }
                    <select name="method" class="form-select">
                        <option value="">All Methods</option>
                        <option value="card" selected="@(methodValue == "card")">Card</option>
                        <option value="upi" selected="@(methodValue == "upi")">UPI</option>
                        <option value="netbanking" selected="@(methodValue == "netbanking")">Net Banking</option>
                        <option value="wallet" selected="@(methodValue == "wallet")">Wallet</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label fw-semibold">From Date</label>
                    <input type="date" name="fromDate" class="form-control" value="@ViewBag.FromDate" />
                </div>
                <div class="col-md-3">
                    <label class="form-label fw-semibold">To Date</label>
                    <input type="date" name="toDate" class="form-control" value="@ViewBag.ToDate" />
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-md-6">
                    <button type="submit" class="btn btn-primary me-2">
                        <i class="fa-solid fa-filter me-1"></i>Apply Filters
                    </button>
                    <a href="/PartnerTransactions/Index" class="btn btn-outline-secondary">
                        <i class="fa-solid fa-refresh me-1"></i>Clear
                    </a>
                </div>
            </div>
        </form>
    </div>

    @if (Model?.Count > 0)
    {
        <!-- Transactions List -->
        <div id="transactionsContainer">
            @foreach (var payment in Model)
            {
                <div class="transaction-card">
                    <div class="d-flex justify-content-between align-items-start flex-wrap">
                        <div class="d-flex align-items-center gap-3 flex-grow-1 mb-2 mb-md-0">
                            <div class="transaction-id">@payment.id</div>
                            <span class="status-badge status-@payment.status">@payment.status</span>
                            @if (payment.type?.ToString() == "refund")
                            {
                                <small class="text-muted d-none d-md-inline">refund</small>
                            }
                            else if (payment.method != null)
                            {
                                <small class="text-muted d-none d-md-inline">@payment.method</small>
                            }
                        </div>
                        <div class="d-flex align-items-center gap-3 flex-wrap">
                            <div class="transaction-amount amount-@payment.status">₹@(((long)payment.amount / 100m).ToString("N2"))</div>
                            <div class="text-muted d-none d-md-block" style="font-size: 0.875rem;">
                                @DateTime.UnixEpoch.AddSeconds((long)payment.created_at).ToString("MMM dd, yyyy HH:mm")
                            </div>
                            <div class="text-muted d-md-none" style="font-size: 0.75rem;">
                                @DateTime.UnixEpoch.AddSeconds((long)payment.created_at).ToString("MMM dd")
                            </div>
                            <button class="btn btn-sm btn-outline-info" onclick="viewDetails('@payment.id')">
                                <i class="fa-solid fa-eye d-md-none"></i>
                                <span class="d-none d-md-inline">Details</span>
                            </button>
                        </div>
                    </div>
                    <!-- Mobile-only additional info -->
                    <div class="d-md-none mt-2 pt-2 border-top">
                        <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted">
                                @if (payment.type?.ToString() == "refund")
                                {
                                    <span>Refund</span>
                                }
                                else if (payment.method != null)
                                {
                                    <span>@payment.method</span>
                                }
                            </small>
                            <small class="text-muted">
                                @DateTime.UnixEpoch.AddSeconds((long)payment.created_at).ToString("HH:mm")
                            </small>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
    else
    {
        <div class="text-center py-5">
            <i class="fa-solid fa-credit-card" style="font-size: 4rem; color: #e5e7eb; margin-bottom: 1rem;"></i>
            <h3>No Transactions Found</h3>
            <p class="text-muted">You don't have any payment transactions yet.</p>
        </div>
    }
</div>

<!-- Payment Details Modal -->
<div class="modal fade" id="paymentDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Payment Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="paymentDetailsContent">
                <div class="text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function viewDetails(paymentId) {
            $('#paymentDetailsModal').modal('show');
            
            $.get('/PartnerTransactions/GetPaymentDetails', { paymentId: paymentId })
                .done(function(response) {
                    if (response.success) {
                        const payment = response.data;
                        let html = `
                            <div class="row">
                                <div class="col-md-6">
                                    <h6>Payment Information</h6>
                                    <table class="table table-sm">
                                        <tr><td><strong>Payment ID:</strong></td><td><code>${payment.id}</code></td></tr>
                                        <tr><td><strong>Amount:</strong></td><td>₹${(payment.amount / 100).toFixed(2)}</td></tr>
                                        <tr><td><strong>Status:</strong></td><td><span class="badge bg-${getStatusClass(payment.status)}">${payment.status}</span></td></tr>
                                        <tr><td><strong>Method:</strong></td><td>${payment.method || 'N/A'}</td></tr>
                                        <tr><td><strong>Created:</strong></td><td>${new Date(payment.created_at * 1000).toLocaleString()}</td></tr>
                                    </table>
                                </div>
                                <div class="col-md-6">
                                    <h6>Customer Information</h6>
                                    <table class="table table-sm">
                                        <tr><td><strong>Email:</strong></td><td>${payment.email || 'N/A'}</td></tr>
                                        <tr><td><strong>Contact:</strong></td><td>${payment.contact || 'N/A'}</td></tr>
                                    </table>
                                </div>
                            </div>
                        `;
                        
                        // Add card details if payment method is card
                        if (payment.method === 'card' && payment.card) {
                            html += `
                                <div class="row mt-3">
                                    <div class="col-12">
                                        <h6><i class="fas fa-credit-card me-2"></i>Card Details</h6>
                                        <table class="table table-sm">
                                            <tr><td><strong>Card Number:</strong></td><td>**** **** **** ${payment.card.last4 || '****'}</td></tr>
                                            <tr><td><strong>Card Network:</strong></td><td>${payment.card.network ? payment.card.network.toUpperCase() : 'N/A'}</td></tr>
                                            <tr><td><strong>Card Type:</strong></td><td>${payment.card.type ? payment.card.type.toUpperCase() : 'N/A'}</td></tr>
                                            <tr><td><strong>Issuer:</strong></td><td>${payment.card.issuer || 'N/A'}</td></tr>
                                            <tr><td><strong>International:</strong></td><td>${payment.card.international ? 'Yes' : 'No'}</td></tr>
                                        </table>
                                    </div>
                                </div>
                            `;
                        }
                        
                        // Add refund destination details if it's a refund
                        if (payment.type === 'refund' && payment.refund_method) {
                            html += `
                                <div class="row mt-3">
                                    <div class="col-12">
                                        <h6><i class="fas fa-undo me-2"></i>Refund Details</h6>
                                        <table class="table table-sm">
                                            <tr><td><strong>Original Payment:</strong></td><td><code>${payment.original_payment_id || 'N/A'}</code></td></tr>
                                            <tr><td><strong>Refunded to:</strong></td><td>${payment.refund_method.toUpperCase()}</td></tr>
                            `;
                            
                            if (payment.refund_method === 'card' && payment.card) {
                                html += `
                                            <tr><td><strong>Card Number:</strong></td><td>**** **** **** ${payment.card.last4 || '****'}</td></tr>
                                            <tr><td><strong>Card Network:</strong></td><td>${payment.card.network ? payment.card.network.toUpperCase() : 'N/A'}</td></tr>
                                `;
                            }
                            
                            html += `
                                        </table>
                                        <div class="alert alert-info mt-2">
                                            <i class="fas fa-info-circle me-1"></i>
                                            Refund will be processed to the original payment method within 5-7 business days.
                                        </div>
                                    </div>
                                </div>
                            `;
                        }
                        
                        $('#paymentDetailsContent').html(html);
                    } else {
                        $('#paymentDetailsContent').html(`<div class="alert alert-danger">${response.message}</div>`);
                    }
                })
                .fail(function() {
                    $('#paymentDetailsContent').html('<div class="alert alert-danger">Failed to load payment details</div>');
                });
        }

        function getStatusClass(status) {
            switch(status) {
                case 'captured': return 'success';
                case 'failed': return 'danger';
                case 'refunded': return 'warning';
                default: return 'secondary';
            }
        }
    </script>
}