@{
    ViewData["Title"] = "Sales Overview";
}

<style>
    @@keyframes fadeInUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
    @@keyframes slideInLeft { from { opacity: 0; transform: translateX(-50px); } to { opacity: 1; transform: translateX(0); } }
    @@keyframes bounce { 0%, 20%, 50%, 80%, 100% { transform: translateY(0); } 40% { transform: translateY(-10px); } 60% { transform: translateY(-5px); } }
    
    .dashboard-card {
        background: white;
        border-radius: 12px;
        padding: 1.25rem;
        box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        border: 1px solid rgba(0,0,0,0.05);
        transition: all 0.3s;
        animation: fadeInUp 0.6s ease-out;
    }
    .dashboard-card:hover { transform: translateY(-5px); box-shadow: 0 12px 40px rgba(0,0,0,0.15); }
    .stat-card { position: relative; overflow: hidden; min-height: 120px; }
    .stat-number { font-size: 2rem; font-weight: 700; margin: 0; }
    .stat-label { color: #6b7280; font-size: 0.85rem; margin-top: 0.5rem; }
    .stat-icon { font-size: 2.5rem; opacity: 0.15; position: absolute; right: 1rem; top: 1rem; animation: bounce 2s infinite; }
    .earning-card .stat-number { color: #10b981; }
    .expense-card .stat-number { color: #ef4444; }
    .profit-card .stat-number { color: #4f46e5; }
    .chart-card { min-height: 320px; }
    .chart-card canvas { height: 250px !important; }
    .chart-card.sales-status-card { display: flex; flex-direction: column; }
    .chart-card.sales-status-card canvas { flex: 1; width: 100% !important; height: 100% !important; max-height: 280px; }
    .table-card { min-height: 320px; }
    .table-responsive { max-height: 250px; overflow-y: auto; }
    .table-responsive::-webkit-scrollbar { width: 4px; }
    .table-responsive::-webkit-scrollbar-thumb { background: #888; border-radius: 10px; }
    .dark-mode .dashboard-card { background: #222639 !important; border-color: #2c3049 !important; color: #e4e6eb !important; }
    .dark-mode .stat-label { color: #a6adc8 !important; }
    .animated-row { animation: slideInLeft 0.5s ease-out; }
    .card-1 { animation-delay: 0.1s; }
    .card-2 { animation-delay: 0.2s; }
    .card-3 { animation-delay: 0.3s; }
    .chart-1 { animation-delay: 0.4s; }
    .chart-2 { animation-delay: 0.5s; }
    .chart-3 { animation-delay: 0.6s; }
    .chart-4 { animation-delay: 0.7s; }
</style>

<div class="content">
    <nav class="mb-3" aria-label="breadcrumb">
        <ol class="breadcrumb mb-0">
            <li class="breadcrumb-item"><a href="/Home/Index">Home</a></li>
            <li class="breadcrumb-item active">Sales Overview</li>
        </ol>
    </nav>

    <h1 class="h3 mb-4" style="animation: fadeInUp 0.5s ease-out;"><i class="fa-solid fa-chart-line me-2"></i>Sales Overview Dashboard</h1>

    <!-- Stats Cards -->
    <div class="row g-3 mb-4">
        <div class="col-md-4">
            <div class="dashboard-card stat-card earning-card card-1">
                <i class="fa-solid fa-sack-dollar stat-icon"></i>
                <h2 class="stat-number" id="totalEarning">₹0</h2>
                <p class="stat-label">Total Earnings</p>
            </div>
        </div>
        <div class="col-md-4">
            <div class="dashboard-card stat-card expense-card card-2">
                <i class="fa-solid fa-money-bill-trend-up stat-icon"></i>
                <h2 class="stat-number" id="totalExpenses">₹0</h2>
                <p class="stat-label">Total Expenses</p>
            </div>
        </div>
        <div class="col-md-4">
            <div class="dashboard-card stat-card profit-card card-3">
                <i class="fa-solid fa-chart-line stat-icon"></i>
                <h2 class="stat-number" id="totalProfit">₹0</h2>
                <p class="stat-label">Total Profit</p>
            </div>
        </div>
    </div>

    <div class="row g-3 mb-4" style="align-items: stretch;">
        <!-- Sales Report -->
        <div class="col-lg-8">
            <div class="dashboard-card chart-card chart-1 h-100">
                <h5 class="mb-3"><i class="fa-solid fa-chart-column me-2"></i>Sales Report (Last 6 Months)</h5>
                <canvas id="salesReportChart"></canvas>
            </div>
        </div>

        <!-- Sales Status -->
        <div class="col-lg-4">
            <div class="dashboard-card chart-card sales-status-card chart-2 h-100">
                <h5 class="mb-3"><i class="fa-solid fa-chart-pie me-2"></i>Sales Status</h5>
                <canvas id="salesStatusChart"></canvas>
            </div>
        </div>
    </div>

    <div class="row g-3 mb-4">
        <!-- Sales Growth -->
        <div class="col-lg-6">
            <div class="dashboard-card chart-card chart-3">
                <h5 class="mb-3"><i class="fa-solid fa-arrow-trend-up me-2"></i>Sales Growth</h5>
                <canvas id="salesGrowthChart"></canvas>
            </div>
        </div>

        <!-- Recent Bookings -->
        <div class="col-lg-6">
            <div class="dashboard-card table-card chart-4">
                <h5 class="mb-3"><i class="fa-solid fa-book me-2"></i>Recent Sales/Bookings</h5>
                <div class="table-responsive">
                    <table class="table table-sm" id="recentBookingsTable">
                        <thead>
                            <tr>
                                <th>Booking ID</th>
                                <th>Amount</th>
                                <th>Status</th>
                                <th>Date</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        let charts = {};

        document.addEventListener('DOMContentLoaded', function() {
            loadSalesOverviewData();
        });

        function loadSalesOverviewData() {
            console.log('Loading sales overview data...');
            fetch('/Home/GetSalesOverviewData')
                .then(response => {
                    console.log('Response status:', response.status);
                    return response.json();
                })
                .then(data => {
                    console.log('Sales Overview Data:', data);
                    updateStats(data);
                    renderSalesReportChart(data.salesReport);
                    renderSalesStatusChart(data.salesStatus);
                    renderSalesGrowthChart(data.salesReport);
                    renderRecentBookings(data.recentBookings);
                })
                .catch(error => {
                    console.error('Error loading sales data:', error);
                    // Show error message in Sales Status chart
                    const canvas = document.getElementById('salesStatusChart');
                    const parent = canvas.parentElement;
                    parent.innerHTML = '<div class="text-center py-4"><i class="fa-solid fa-exclamation-triangle text-warning mb-2" style="font-size: 3rem;"></i><p class="text-muted">Error loading sales data</p></div>';
                });
        }

        function updateStats(data) {
            animateNumber('totalEarning', data.totalEarning, '₹');
            animateNumber('totalExpenses', data.totalExpenses, '₹');
            animateNumber('totalProfit', data.totalProfit, '₹');
        }

        function animateNumber(elementId, targetValue, prefix = '') {
            const element = document.getElementById(elementId);
            const duration = 2000;
            const startTime = performance.now();
            const startValue = 0;

            function updateNumber(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                const easeOutQuart = 1 - Math.pow(1 - progress, 4);
                const currentValue = Math.floor(startValue + (targetValue - startValue) * easeOutQuart);
                
                element.textContent = prefix + formatNumber(currentValue);
                
                if (progress < 1) {
                    requestAnimationFrame(updateNumber);
                }
            }
            
            requestAnimationFrame(updateNumber);
        }

        function renderSalesReportChart(data) {
            const ctx = document.getElementById('salesReportChart').getContext('2d');
            if (charts.salesReport) charts.salesReport.destroy();
            charts.salesReport = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(d => d.month),
                    datasets: [{
                        label: 'Sales',
                        data: data.map(d => d.sales),
                        backgroundColor: '#4f46e5',
                        borderRadius: 8
                    }]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    plugins: { legend: { display: false } }, 
                    scales: { y: { beginAtZero: true } },
                    animation: {
                        duration: 2000,
                        easing: 'easeOutBounce'
                    }
                }
            });
        }

        function renderSalesStatusChart(data) {
            console.log('Sales Status Data:', data);
            const ctx = document.getElementById('salesStatusChart').getContext('2d');
            if (charts.salesStatus) charts.salesStatus.destroy();
            
            // Handle case when no data is available
            if (!data || (data.paidCount === 0 && data.pendingCount === 0 && data.overdueCount === 0)) {
                // Show "No Data" message
                const canvas = document.getElementById('salesStatusChart');
                const parent = canvas.parentElement;
                parent.innerHTML = '<div class="text-center py-4"><i class="fa-solid fa-chart-pie text-muted mb-2" style="font-size: 3rem;"></i><p class="text-muted">No sales data available</p></div>';
                return;
            }
            
            charts.salesStatus = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Paid', 'Pending', 'Overdue'],
                    datasets: [{
                        data: [data.paidCount || 0, data.pendingCount || 0, data.overdueCount || 0],
                        backgroundColor: ['#10b981', '#f59e0b', '#ef4444'],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: true,
                    aspectRatio: 1,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 15,
                                usePointStyle: true,
                                font: { size: 12 }
                            }
                        }
                    },
                    animation: {
                        duration: 2000,
                        easing: 'easeOutElastic'
                    }
                }
            });
        }

        function renderSalesGrowthChart(data) {
            const ctx = document.getElementById('salesGrowthChart').getContext('2d');
            if (charts.salesGrowth) charts.salesGrowth.destroy();
            charts.salesGrowth = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => d.month),
                    datasets: [{
                        label: 'Sales Growth',
                        data: data.map(d => d.sales),
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    plugins: { legend: { display: false } }, 
                    scales: { y: { beginAtZero: true } },
                    animation: {
                        duration: 2000,
                        easing: 'easeInOutQuart'
                    }
                }
            });
        }

        function renderRecentBookings(data) {
            const tbody = document.querySelector('#recentBookingsTable tbody');
            tbody.innerHTML = '';
            
            if (!data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted py-4">No bookings available</td></tr>';
                return;
            }
            
            data.forEach((booking, index) => {
                setTimeout(() => {
                    const row = document.createElement('tr');
                    row.className = 'animated-row';
                    row.innerHTML = `
                        <td>#${booking.bookingId}</td>
                        <td><strong>₹${formatNumber(booking.bookingAmount)}</strong></td>
                        <td><span class="badge bg-${booking.status === 'Paid' ? 'success' : booking.status === 'Pending' ? 'warning' : 'danger'}">${booking.status}</span></td>
                        <td><small>${booking.createdOn}</small></td>
                    `;
                    tbody.appendChild(row);
                }, index * 200);
            });
        }

        function formatNumber(num) {
            return new Intl.NumberFormat('en-IN').format(num);
        }
    </script>
}