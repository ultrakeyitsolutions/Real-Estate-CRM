<!-- Global Search Bar -->
<div class="global-search-container">
    <div class="search-wrapper">
        <i class="search-icon" data-feather="search"></i>
        <input type="text" 
               id="globalSearchInput" 
               class="global-search-input" 
               placeholder="Search leads, documents, projects, anything here..." 
               autocomplete="off">
        <div id="searchResults" class="search-results-dropdown"></div>
    </div>
</div>

<style>
    .global-search-container {
        flex: 1;
        max-width: none;
        margin: 0 20px;
        position: relative;
    }

    .search-wrapper {
        position: relative;
        width: 100%;
    }

    .search-icon {
        position: absolute;
        left: 14px;
        top: 50%;
        transform: translateY(-50%);
        width: 18px;
        height: 18px;
        color: #6c757d;
        pointer-events: none;
        z-index: 1;
    }

    .global-search-input {
        width: 199%;
        padding: 10px 16px 10px 44px;
        border: 1px solid #dee2e6;
        border-radius: 25px;
        font-size: 14px;
        transition: all 0.3s ease;
        background: #fff;
    }

    .global-search-input:focus {
        outline: none;
        border-color: #6f42c1;
        box-shadow: 0 0 0 3px rgba(111, 66, 193, 0.1);
    }

    .search-results-dropdown {
        position: absolute;
        top: calc(100% + 8px);
        left: 0;
        right: 0;
        background: #fff;
        border: 1px solid #dee2e6;
        border-radius: 12px;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
        max-height: 450px;
        overflow-y: auto;
        display: none;
        z-index: 1050;
        width: 199%;
        scrollbar-width: none;
    }

    .search-results-dropdown::-webkit-scrollbar {
        display: none;
    }

    .search-results-dropdown.show {
        display: block;
    }

    .search-result-item {
        padding: 12px 16px;
        border-bottom: 1px solid #f1f3f4;
        cursor: pointer;
        transition: background 0.2s;
        display: flex;
        align-items: center;
        gap: 12px;
        text-decoration: none;
        color: inherit;
    }

    .search-result-item:last-child {
        border-bottom: none;
    }

    .search-result-item:hover {
        background: #f8f9fa;
    }

    .search-result-icon {
        width: 40px;
        height: 40px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }

    /* .search-result-icon.lead { background: #e3f2fd; color: #1976d2; }
    .search-result-icon.property { background: #f3e5f5; color: #7b1fa2; }
    .search-result-icon.agent { background: #e8f5e9; color: #388e3c; }
    .search-result-icon.booking { background: #fff3e0; color: #f57c00; }
    .search-result-icon.document { background: #fce4ec; color: #c2185b; }
    .search-result-icon.page { background: #e8eaf6; color: #3f51b5; }
    .search-result-icon.agent-document { background: #fce4ec; color: #c2185b; }
    .search-result-icon.property-document { background: #fce4ec; color: #c2185b; }
    .search-result-icon.partner-document { background: #fce4ec; color: #c2185b; } */

        .search-result-icon.lead {
            background: #eef5ff;
            color: #4a6fa5;
        }

        .search-result-icon.property {
            background: #f5effa;
            color: #6f4aa5;
        }

        .search-result-icon.agent {
            background: #edf7f0;
            color: #4a8f6a;
        }

        .search-result-icon.booking {
            background: #fff6ec;
            color: #c47a2c;
        }

        .search-result-icon.document {
            background: #fdeff3;
            color: #a64d79;
        }

        .search-result-icon.page {
            background: #f0f2fb;
            color: #5a6bb0;
        }

        .search-result-icon.agent-document {
            background: #fdeff3;
            color: #a64d79;
        }

        .search-result-icon.property-document {
            background: #fdeff3;
            color: #a64d79;
        }

        .search-result-icon.partner-document {
            background: #fdeff3;
            color: #a64d79;
        }


    .search-result-content {
        flex: 1;
        min-width: 0;
    }

    .search-result-title {
        font-weight: 600;
        font-size: 14px;
        color: #212529;
        margin-bottom: 2px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .search-result-subtitle {
        font-size: 12px;
        color: #6c757d;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .search-result-type {
        font-size: 10px;
        padding: 3px 8px;
        border-radius: 12px;
        background: #e9ecef;
        color: #495057;
        font-weight: 600;
        flex-shrink: 0;
        white-space: nowrap;
    }

    .search-no-results, .search-loading {
        padding: 24px;
        text-align: center;
        color: #6c757d;
        font-size: 14px;
    }

    /* Dark Mode */
    .dark-mode .global-search-input {
        background: #2c3049;
        border-color: #3d4461;
        color: #e4e6eb;
    }

    .dark-mode .global-search-input:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .dark-mode .search-results-dropdown {
        background: #222639;
        border-color: #2c3049;
    }

    .dark-mode .search-result-item {
        border-bottom-color: #2c3049;
        color: #e4e6eb;
    }

    .dark-mode .search-result-item:hover {
        background: #2c3049;
    }

    .dark-mode .search-result-title {
        color: #e4e6eb;
    }

    .dark-mode .search-result-subtitle {
        color: #a6adc8;
    }

    .dark-mode .search-result-type {
        background: #3d4461;
        color: #e4e6eb;
    }

    .page-card {
        border: none !important;
        color: #fff !important;
        box-shadow: 0 6px 14px rgba(0,0,0,0.15);
        transition: all 0.3s ease;
        font-weight: 600;
    }

        /* Make text & icons follow card color */
        .page-card i,
        .page-card div {
            color: inherit !important;
            fill: currentColor;
        }


    .dark-mode .page-card {
        border-color: #3d4461 !important;
        background: #2c3049 !important;
    }

    .page-card:hover {
        transform: translateY(-6px);
        filter: brightness(1.15);
    }


    .dark-mode .page-card:hover {
        background: #3d4461 !important;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    /* Mobile Responsive */
    @@media (max-width: 991px) {
        .navbar-bg {
            padding: 0 5px !important;
            display: flex !important;
            justify-content: space-between !important;
            align-items: center !important;
        }

        .sidebar-toggle {
            padding: 0 5px !important;
            flex-shrink: 0;
        }

        .global-search-container {
            flex: 1;
            max-width: none;
            margin: 0 5px;
            min-width: 0;
        }

        .global-search-input {
            font-size: 13px;
            padding: 7px 8px 7px 32px;
            width: 100% !important;
            border-radius: 20px;
        }

        .search-icon {
            left: 8px;
            width: 14px;
            height: 14px;
        }

        .search-results-dropdown {
            max-height: 70vh;
            border-radius: 8px;
            left: 0 !important;
            right: 0 !important;
            width: 100% !important;
            position: fixed !important;
            top: 56px !important;
            left: 0 !important;
            right: 0 !important;
            margin: 0 !important;
            border-radius: 0 !important;
            border-left: none !important;
            border-right: none !important;
        }

        .search-result-item {
            padding: 10px 12px;
        }

        .search-result-icon {
            width: 36px;
            height: 36px;
        }

        .search-result-title {
            font-size: 13px;
        }

        .search-result-subtitle {
            font-size: 11px;
        }

        .search-result-type {
            font-size: 9px;
            padding: 2px 6px;
        }

        .navbar-collapse {
            flex-shrink: 0;
        }

        .navbar-nav {
            margin-left: 0 !important;
            flex-direction: row !important;
            align-items: center !important;
        }

        .nav-item {
            padding: 0 3px !important;
        }

        .nav-item .nav-icon,
        .nav-item .nav-link {
            padding: 0 5px !important;
        }

        .nav-item .avatar {
            width: 28px !important;
            height: 28px !important;
        }

        .nav-item .text-dark {
            display: none !important;
        }
    }

   /* ===== ULTRAKEY CRM THEME CARDS ===== */

.card-leads {
    background: linear-gradient(135deg, #4f46e5, #6366f1);
}

.card-properties {
    background: linear-gradient(135deg, #0ea5e9, #06b6d4);
}

.card-finance {
    background: linear-gradient(135deg, #10b981, #34d399);
}

.card-bookings {
    background: linear-gradient(135deg, #f59e0b, #fbbf24);
}

.card-settings {
    background: linear-gradient(135deg, #8b5cf6, #a78bfa);
}

.card-dashboard {
    background: linear-gradient(135deg, #ec4899, #f472b6);
}


/* ===== CARD BASE STYLE ===== */

.page-card {
    border: none !important;
    color: #ffffff !important;
    box-shadow: 0 6px 14px rgba(0,0,0,0.15);
    transition: all 0.3s ease;
    font-weight: 600;
}

/* TEXT & ICON VISIBILITY */

.page-card div {
    color: inherit !important;
    font-size: 14px;
    letter-spacing: 0.3px;
}

.page-card i {
            color: #inherit !important;
            display: block;
            margin: 0 auto;
            color: inherit;
}

/* HOVER EFFECT */

.page-card:hover {
            transform: translateY(-5px) scale(1.02) ;
    box-shadow: 0 14px 26px rgba(0,0,0,0.25);
}


/* ===== FAVORITES TITLE FIX ===== */

.favorites-title {
    font-size: 15px;
    font-weight: 600;
    color: #1e293b;
}

/* DARK MODE */

body.dark-mode .favorites-title {
    color: #e2e8f0;
    }

    .page-card {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
    }
</style>

<script>
    let searchTimeout;
    const searchInput = document.getElementById('globalSearchInput');
    const searchResults = document.getElementById('searchResults');

    searchInput.addEventListener('focus', function() {
        if (this.value.trim().length === 0) {
            showRecentAndPages();
        }
    });

    searchInput.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        const query = this.value.trim();

        if (query.length === 0) {
            showRecentAndPages();
            return;
        }

        if (query.length < 2) {
            searchResults.classList.remove('show');
            return;
        }

        searchResults.innerHTML = '<div class="search-loading"><i data-feather="loader"></i> Searching...</div>';
        searchResults.classList.add('show');
        feather.replace();

        searchTimeout = setTimeout(() => {
            fetch(`/Search/GlobalSearch?query=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.results.length > 0) {
                        fetch('/Search/SaveRecentSearch', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ searchTerm: query })
                        });
                        displayGroupedResults(data.results);
                    } else {
                        searchResults.innerHTML = '<div class="search-no-results">No results found</div>';
                    }
                })
                .catch(error => {
                    searchResults.innerHTML = '<div class="search-no-results">Error searching</div>';
                });
        }, 300);
    });

    function showRecentAndPages() {
        const isDark = document.body.classList.contains('dark-mode');
        let html = '<div style="padding: 16px;">';
        
        // Load favorites and recent searches from database
        Promise.all([
            fetch('/Search/GetFavorites').then(r => r.json()),
            fetch('/Search/GetRecentSearches').then(r => r.json())
        ]).then(([favData, recentData]) => {
            const favorites = favData.favorites || [];
            const recent = recentData.searches || [];
            
            // Show recent searches
            if (recent.length > 0) {
                html += `<div style="font-weight: 600; font-size: 12px; color: ${isDark ? '#a6adc8' : '#6c757d'}; margin-bottom: 12px;">RECENT SEARCHES</div>`;
                html += `<div style="display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 16px;">`;
                recent.forEach(term => {
                    html += `<div class="recent-pill" style="padding: 6px 12px; background: ${isDark ? '#3d4461' : '#f0f0f0'}; color: ${isDark ? '#e4e6eb' : '#212529'}; border-radius: 16px; cursor: pointer; white-space: nowrap; font-size: 13px; display: flex; align-items: center; gap: 6px;">
                        <i data-feather="clock" style="width: 14px; height: 14px; color: ${isDark ? '#a6adc8' : '#6c757d'};"></i>
                        <span onclick="searchFor('${term}')">${term}</span>
                        <i data-feather="x" onclick="removeRecentSearch(event, '${term}')" style="width: 14px; height: 14px; color: ${isDark ? '#a6adc8' : '#6c757d'}; cursor: pointer;"></i>
                    </div>`;
                });
                html += '</div>';
            }
            
            // Show favorites
            if (favorites.length > 0) {
                html += `<div style="font-weight: 600; font-size: 12px; color: ${isDark ? '#a6adc8' : '#6c757d'}; margin: 16px 0 12px 0;">FAVORITES</div>`;
                html += '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 12px; margin-bottom: 16px;">';
                    favorites.forEach(fav => {
        html += `<a href="${fav.pageUrl}"
            class="page-card card-${fav.pageName.toLowerCase()}"
            style="padding:16px; border-radius:10px; text-align:center;
            text-decoration:none; position:relative;">

            <i data-feather="${fav.pageIcon}"
               style="width:26px; height:26px; margin-bottom:8px;"></i>

            <div>${fav.pageName}</div>

            <i data-feather="star"
               onclick="toggleFavorite(event,'${fav.pageName}','${fav.pageUrl}','${fav.pageIcon}','${fav.pageColor}')"
               style="position:absolute; top:8px; right:8px;
               width:16px; height:16px;
               color:#FFD700; fill:#FFD700; cursor:pointer;">
            </i>

        </a>`;
    });

                html += '</div>';
            }
            
            // Show quick access
            html += `<div style="font-weight: 600; font-size: 12px; color: ${isDark ? '#a6adc8' : '#6c757d'}; margin: 16px 0 12px 0;">QUICK ACCESS</div>`;
            html += '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 12px;">';
            
            const pages = [
                {name: 'Leads', icon: 'users', url: '/Leads/Index', color: '#1976d2'},
                {name: 'Properties', icon: 'home', url: '/Properties/Index', color: '#7b1fa2'},
                {name: 'Finance', icon: 'dollar-sign', url: '/Expenses/Index', color: '#388e3c'},
                {name: 'Bookings', icon: 'book-open', url: '/Bookings/Index', color: '#f57c00'},
                {name: 'Settings', icon: 'settings', url: '/Settings/Index', color: '#3f51b5'},
                {name: 'Dashboard', icon: 'home', url: '/Home/Index', color: '#1976d2'}
            ];
            
            // const favoriteNames = favorites.map(f => f.pageName);
            // pages.forEach(page => {
            //     const isFav = favoriteNames.includes(page.name);
            //     html += `<a href="${page.url}" class="page-card" style="padding: 16px; border: 1px solid ${isDark ? '#3d4461' : '#e0e0e0'}; background: ${isDark ? '#2c3049' : '#fff'}; color: ${isDark ? '#e4e6eb' : '#212529'}; border-radius: 8px; text-align: center; text-decoration: none; transition: all 0.2s; position: relative;">
            //         <i data-feather="${page.icon}" style="width: 24px; height: 24px; color: ${page.color}; margin-bottom: 8px;"></i>
            //         <div style="font-size: 13px; font-weight: 500;">${page.name}</div>
            //         <i data-feather="star" onclick="toggleFavorite(event, '${page.name}', '${page.url}', '${page.icon}', '${page.color}')" style="position: absolute; top: 8px; right: 8px; width: 16px; height: 16px; color: ${isFav ? '#FFD700' : (isDark ? '#a6adc8' : '#6c757d')}; ${isFav ? 'fill: #FFD700;' : ''} cursor: pointer;"></i>
            //     </a>`;
            // });
                const favoriteNames = favorites.map(f => f.pageName);

    pages.forEach(page => {
        const isFav = favoriteNames.includes(page.name);

       html += `<a href="${page.url}"
            class="page-card card-${page.name.toLowerCase()}"
            style="padding: 16px;
                   border-radius: 8px;
                   text-align: center;
                   text-decoration: none;
                   transition: all 0.2s;
                   position: relative;">


            <i data-feather="${page.icon}"
               style="width: 24px; height: 24px; margin-bottom: 8px;"></i>

            <div style="font-size: 13px; font-weight: 500;">
                ${page.name}
            </div>

            <i data-feather="star"
               onclick="toggleFavorite(event, '${page.name}', '${page.url}', '${page.icon}', '${page.color}')"
               style="position: absolute; top: 8px; right: 8px; width: 16px; height: 16px;
               color: ${isFav ? '#FFD700' : (isDark ? '#a6adc8' : '#6c757d')};
               ${isFav ? 'fill: #FFD700;' : ''} cursor: pointer;">
            </i>
        </a>`;
    });

            
            html += '</div></div>';
            searchResults.innerHTML = html;
            searchResults.classList.add('show');
            feather.replace();
        });
    }

    function displayGroupedResults(results) {
        const grouped = {};
        results.forEach(r => {
            if (!grouped[r.type]) grouped[r.type] = [];
            grouped[r.type].push(r);
        });
        
        let html = '';
        Object.keys(grouped).forEach(type => {
            html += `<div style="padding: 12px 16px; background: #f8f9fa; font-weight: 700; font-size: 13px; color: #212529; border-bottom: 1px solid #e0e0e0;">${type.toUpperCase()}</div>`;
            grouped[type].forEach(result => {
                const iconType = result.type.toLowerCase().replace(' ', '-');
                html += `
                    <a href="${result.url}" class="search-result-item">
                        <div class="search-result-icon ${iconType}">
                            <i data-feather="${result.icon}"></i>
                        </div>
                        <div class="search-result-content">
                            <div class="search-result-title">${result.title}</div>
                            <div class="search-result-subtitle">${result.subtitle}</div>
                        </div>
                        <span class="search-result-type">${result.type}</span>
                    </a>
                `;
            });
        });
        searchResults.innerHTML = html;
        feather.replace();
    }

    window.toggleFavorite = function(event, name, url, icon, color) {
        event.preventDefault();
        event.stopPropagation();
        fetch('/Search/ToggleFavorite', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ pageName: name, pageUrl: url, pageIcon: icon, pageColor: color })
        }).then(r => r.json()).then(data => {
            if (data.success) {
                showRecentAndPages();
            }
        });
    };

    window.removeRecentSearch = function(event, term) {
        event.stopPropagation();
        fetch('/Search/RemoveRecentSearch', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ searchTerm: term })
        }).then(r => r.json()).then(data => {
            if (data.success) {
                showRecentAndPages();
            }
        });
    };

    window.searchFor = function(term) {
        event.stopPropagation();
        searchInput.value = term;
        searchResults.innerHTML = '<div class="search-loading"><i data-feather="loader"></i> Searching...</div>';
        searchResults.classList.add('show');
        feather.replace();
        
        fetch(`/Search/GlobalSearch?query=${encodeURIComponent(term)}`)
            .then(response => response.json())
            .then(data => {
                if (data.success && data.results.length > 0) {
                    displayGroupedResults(data.results);
                } else {
                    searchResults.innerHTML = '<div class="search-no-results">No results found</div>';
                }
            })
            .catch(error => {
                searchResults.innerHTML = '<div class="search-no-results">Error searching</div>';
            });
    };

    // Close dropdown when clicking outside
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.global-search-container')) {
            searchResults.classList.remove('show');
        }
    });

    // Clear search on ESC
    searchInput.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            this.value = '';
            searchResults.classList.remove('show');
        }
    });
</script>
