@model CRM.Models.FollowUpModel

<!-- Follow-Up Modal -->
<div class="modal fade" id="followUpModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-slideout" style="max-width: 400px !important; width: 400px;">
        <div class="modal-content">
            <form id="followUpForm" onsubmit="return saveFollowUp(event)">
                <div class="modal-header text-white" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 0.875rem 1rem;">
                    <h5 class="modal-title" style="font-size: 0.95rem; font-weight: 600;">
                        <i class="fa-solid fa-calendar-plus me-2"></i>Add / Update Follow-Up
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body" style="padding: 1rem;">
                    <input type="hidden" id="fuLeadId" name="LeadId" value="0" />
                    <input type="hidden" id="fuFollowUpId" name="FollowUpId" value="0" />

                    <div class="mb-2">
                        <label class="form-label">Stage <span class="text-danger">*</span></label>
                        <select class="form-control" id="fuStage" name="Stage" required>
                            <option value="">Select Stage</option>
                            <option value="Office Meeting">Office Meeting</option>
                            <option value="Site Visit Requested">Site Visit Requested</option>
                            <option value="Site Visited">Site Visited</option>
                            <option value="Discussions">Discussions</option>
                            <option value="Negotiation">Negotiation</option>
                            <option value="Site Visit Done">✔️ Site Visit Done</option>
                            <option value="Negotiation">💬 Negotiation</option>
                            <option value="Booked">Booked</option>
                            <option value="Location Change">Location Change</option>
                            <option value="Temporarily Stopped">Temporarily Stopped</option>
                            <option value="Searching">Searching</option>
                        </select>
                    </div>

                    <div class="mb-2">
                        <label class="form-label">Project / Property</label>
                        <select class="form-control" id="fuPropertyId" name="PropertyId">
                            <option value="">Select Project</option>
                            <!-- Projects will be loaded dynamically -->
                        </select>
                        <small class="text-muted">Select the property for site visit</small>
                    </div>

                    <div class="mb-2">
                        <label class="form-label">Status <span class="text-danger">*</span></label>
                        <select class="form-control" id="fuStatus" name="Status" required>
                            <option value="">Select Status</option>
                            <option value="Active">Active</option>
                            <option value="Spoke">Spoke</option>
                            <option value="No Response">No Response</option>
                            <option value="Lost">Lost</option>
                        </select>
                    </div>

                    <div class="mb-2">
                        <label class="form-label">Follow Up Date <span class="text-danger">*</span></label>
                        <input type="date" class="form-control" id="fuFollowUpDate" name="FollowUpDate" required />
                    </div>

                    <div class="mb-2">
                        <label class="form-label">Follow Up Time</label>
                        <input type="time" class="form-control" id="fuFollowUpTime" name="FollowUpTime" />
                    </div>

                    <div class="mb-2">
                        <label class="form-label">Rating</label>
                        <select class="form-control" id="fuRating" name="Rating">
                            <option value="">Select Rating</option>
                            <option value="Cold">Cold</option>
                            <option value="Warm">Warm</option>
                            <option value="Hot">Hot</option>
                            <option value="None">None</option>
                        </select>
                    </div>

                    <div class="mb-2">
                        <label class="form-label">Comments / Remarks</label>
                        <textarea class="form-control" id="fuComments" name="Comments" rows="3" 
                                  placeholder="Enter follow-up notes, discussion points, or action items..."></textarea>
                    </div>

                    <!-- Alert Messages -->
                    <div id="followUpAlert" class="alert d-none mt-2" role="alert"></div>
                </div>

                <div class="modal-footer" style="padding: 0.75rem 1rem;">
                    <button class="btn btn-primary" type="submit" style="padding: 0.5rem 1rem; font-size: 0.875rem;">
                        <i class="fa-solid fa-save me-1"></i>Update
                    </button>
                    <button class="btn btn-secondary" type="button" data-bs-dismiss="modal" style="padding: 0.5rem 1rem; font-size: 0.875rem;">Cancel</button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
    #followUpModal .form-label {
        font-weight: 600;
        color: #2d3748;
        margin-bottom: 0.375rem;
        font-size: 0.8125rem;
    }

    #followUpModal .form-control,
    #followUpModal .form-select {
        border-radius: 6px;
        border: 1px solid #e0e6ed;
        padding: 0.5rem 0.75rem;
        transition: all 0.3s ease;
        font-size: 0.8125rem;
    }
    
    #followUpModal .form-control:focus,
    #followUpModal .form-select:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 0.15rem rgba(102, 126, 234, 0.15);
    }

    #followUpModal .modal-content {
        border: none;
        border-radius: 10px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
    }
    
    #followUpModal .mb-2 {
        margin-bottom: 0.75rem !important;
    }
    
    #followUpModal small.text-muted {
        font-size: 0.75rem;
    }
    
    #followUpModal textarea.form-control {
        min-height: 80px;
    }

    #followUpModal .text-danger {
        font-size: 0.875rem;
    }
    
    #followUpModal .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        border-radius: 8px;
        padding: 0.5rem 1rem;
        font-weight: 600;
        font-size: 0.875rem;
        transition: all 0.3s ease;
    }
    
    #followUpModal .btn-primary:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }
    
    #followUpModal .btn-secondary {
        border-radius: 8px;
        padding: 0.5rem 1rem;
        font-weight: 600;
        font-size: 0.875rem;
    }

</style>

<script>
    // Load properties when modal is opened
    document.getElementById('followUpModal')?.addEventListener('show.bs.modal', function () {
        loadProperties();
    });

    // Function to load properties dropdown
    function loadProperties() {
        fetch('/Properties/GetAllProperties')
            .then(response => response.json())
            .then(data => {
                const dropdown = document.getElementById('fuPropertyId');
                dropdown.innerHTML = '<option value="">Select Project</option>';
                
                if (data.success && data.properties) {
                    data.properties.forEach(property => {
                        const option = document.createElement('option');
                        option.value = property.PropertyId || property.propertyId;
                        option.textContent = property.PropertyName || property.propertyName;
                        dropdown.appendChild(option);
                    });
                }
            })
            .catch(error => {
                console.error('Error loading properties:', error);
            });
    }

    function saveFollowUp(event) {
        event.preventDefault();

        const formData = new FormData(document.getElementById('followUpForm'));
        const data = {};
        formData.forEach((value, key) => {
            if (key === 'LeadId' || key === 'FollowUpId' || key === 'ExecutiveId' || key === 'PropertyId') {
                data[key] = value && value !== '' ? parseInt(value) : null;
            } else if (key === 'FollowUpDate') {
                data[key] = value ? new Date(value).toISOString() : null;
            } else {
                data[key] = value || null;
            }
        });

        // Show loading state
        const submitBtn = event.target.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Saving...';

        fetch('/Leads/SaveFollowUp', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                showFollowUpAlert('success', result.message || 'Follow-up saved successfully!');
                
                // Reload follow-ups if on details page
                if (typeof loadFollowups === 'function') {
                    setTimeout(() => {
                        loadFollowups(data.LeadId);
                    }, 1000);
                }

                // Close modal after 1.5 seconds
                setTimeout(() => {
                    bootstrap.Modal.getInstance(document.getElementById('followUpModal')).hide();
                    document.getElementById('followUpForm').reset();
                    
                    // Reload page if not on details page
                    if (typeof loadFollowups !== 'function') {
                        window.location.reload();
                    }
                }, 1500);
            } else {
                showFollowUpAlert('danger', result.message || 'Failed to save follow-up');
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showFollowUpAlert('danger', 'An error occurred while saving the follow-up');
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalText;
        });

        return false;
    }

    function showFollowUpAlert(type, message) {
        const alertDiv = document.getElementById('followUpAlert');
        alertDiv.className = `alert alert-${type} mt-3`;
        alertDiv.textContent = message;
        alertDiv.classList.remove('d-none');
        
        // Auto-hide success messages
        if (type === 'success') {
            setTimeout(() => {
                alertDiv.classList.add('d-none');
            }, 3000);
        }
    }

    // Reset form when modal is closed
    document.getElementById('followUpModal')?.addEventListener('hidden.bs.modal', function () {
        document.getElementById('followUpForm').reset();
        document.getElementById('followUpAlert').classList.add('d-none');
        
        // Re-enable submit button
        const submitBtn = this.querySelector('button[type="submit"]');
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fa-solid fa-save me-1"></i>Update';
    });

    // Set minimum date to today
    document.addEventListener('DOMContentLoaded', function() {
        const dateInput = document.getElementById('fuFollowUpDate');
        if (dateInput) {
            const today = new Date().toISOString().split('T')[0];
            dateInput.setAttribute('min', today);
        }
    });
</script>
