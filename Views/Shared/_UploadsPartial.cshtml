@model List<CRM.Models.LeadUploadModel>

<div class="uploads-section">
    <!-- Upload Form -->
    <div class="card mb-3">
        <div class="card-body">
            <form id="uploadForm" enctype="multipart/form-data" onsubmit="return uploadFile(event)">
                <input type="hidden" id="uploadLeadId" value="@ViewBag.LeadId" />
                <div class="row g-3">
                    <div class="col-md-8">
                        <label for="fileInput" class="form-label fw-bold">
                            <i class="fa-solid fa-cloud-arrow-up me-1"></i>Upload Document
                        </label>
                        <input type="file" class="form-control" id="fileInput" name="file" required />
                        <small class="text-body-tertiary">Supported: PDF, DOC, DOCX, XLS, XLSX, JPG, PNG (Max: 10MB)</small>
                    </div>
                    <div class="col-md-4 d-flex align-items-end">
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="fa-solid fa-upload me-1"></i>Upload
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Uploads List -->
    @if (Model == null || !Model.Any())
    {
        <div class="text-center py-5">
            <i class="fa-solid fa-file-circle-plus text-body-tertiary" style="font-size: 4rem;"></i>
            <h5 class="mt-3 text-body-tertiary">No Documents Uploaded</h5>
            <p class="text-body-secondary">Upload your first document using the form above.</p>
        </div>
    }
    else
    {
        <div class="row g-3">
            @foreach (var upload in Model)
            {
                var fileExtension = System.IO.Path.GetExtension(upload.FileName)?.ToLower();
                var iconClass = fileExtension switch
                {
                    ".pdf" => "fa-file-pdf text-danger",
                    ".doc" or ".docx" => "fa-file-word text-primary",
                    ".xls" or ".xlsx" => "fa-file-excel text-success",
                    ".jpg" or ".jpeg" or ".png" or ".gif" => "fa-file-image text-info",
                    ".zip" or ".rar" => "fa-file-zipper text-warning",
                    _ => "fa-file text-secondary"
                };

                <div class="col-md-6 col-lg-4">
                    <div class="card upload-card h-100">
                        <div class="card-body">
                            <div class="d-flex align-items-start">
                                <div class="upload-icon me-3">
                                    <i class="fa-solid @iconClass" style="font-size: 2.5rem;"></i>
                                </div>
                                <div class="flex-1">
                                    <h6 class="mb-1 text-truncate" title="@upload.FileName">@upload.FileName</h6>
                                    <p class="mb-2 fs-10 text-body-tertiary">
                                        <i class="fa-solid fa-clock me-1"></i>@upload.UploadedOn.ToString("MMM dd, yyyy")
                                    </p>
                                    <div class="d-flex gap-2">
                                        <a href="/Leads/DownloadFile?uploadId=@upload.UploadId" 
                                           class="btn btn-sm btn-outline-primary" title="Download">
                                            <i class="fa-solid fa-download"></i>
                                        </a>
                                        <button class="btn btn-sm btn-outline-danger" 
                                                onclick="deleteUpload(@upload.UploadId)" title="Delete">
                                            <i class="fa-solid fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
</div>

<style>
    .uploads-section {
        animation: fadeIn 0.3s ease-in;
    }

    .upload-card {
        transition: all 0.3s ease;
        border: 1px solid var(--phoenix-border-color);
    }

    .upload-card:hover {
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.1);
        transform: translateY(-5px);
    }

    .upload-icon {
        flex-shrink: 0;
    }

    @@keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>

<script>
    function uploadFile(event) {
        event.preventDefault();
        
        const leadId = document.getElementById('uploadLeadId').value;
        const fileInput = document.getElementById('fileInput');
        const file = fileInput.files[0];
        
        if (!file) {
            alert('Please select a file');
            return false;
        }

        // Check file size (10MB limit)
        if (file.size > 10 * 1024 * 1024) {
            alert('File size must be less than 10MB');
            return false;
        }

        const formData = new FormData();
        formData.append('leadId', leadId);
        formData.append('file', file);

        // Add anti-forgery token
        const token = document.querySelector('input[name="__RequestVerificationToken"]');
        if (token) {
            formData.append('__RequestVerificationToken', token.value);
        }

        const submitBtn = event.target.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Uploading...';

        fetch('/Leads/SaveLeadUpload', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                fileInput.value = '';
                loadUploads(leadId);
            } else {
                alert(result.message || 'Failed to upload file');
            }
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalText;
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while uploading the file');
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalText;
        });

        return false;
    }

    function deleteUpload(uploadId) {
        if (!confirm('Are you sure you want to delete this file?')) {
            return;
        }

        fetch('/Leads/DeleteUpload?uploadId=' + uploadId, {
            method: 'POST'
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(result => {
            if (result.success) {
                const leadId = document.getElementById('uploadLeadId').value;
                loadUploads(leadId);
            } else {
                alert(result.message || 'Failed to delete file');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            // Only show error if file wasn't actually deleted
            const leadId = document.getElementById('uploadLeadId').value;
            loadUploads(leadId);
        });
    }
</script>
