@model IEnumerable<CRM.Models.RolePermission>
@{
    ViewData["Title"] = "Roles & Permissions";
    var rolesList = Model?.ToList() ?? new List<CRM.Models.RolePermission>();
    var totalRoles = rolesList.Count;
}

<style>
    .modern-header {
        background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
        position: relative;
        overflow: hidden;
        border-radius: 16px;
        box-shadow: 0 8px 32px rgba(79, 70, 229, 0.15);
    }

    .modern-header::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="50" cy="50" r="1" fill="%23ffffff" opacity="0.1"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>') repeat;
        opacity: 0.3;
    }

    .header-content {
        position: relative;
        z-index: 2;
        padding: 2rem;
        color: white;
    }

    .header-title {
        font-size: 1.75rem;
        font-weight: 700;
        margin-bottom: 0.25rem;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .header-subtitle {
        font-size: 0.95rem;
        opacity: 0.9;
        margin-bottom: 1.25rem;
        font-weight: 400;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: 0.875rem;
        margin-top: 1.25rem;
    }

    .stats-card {
        background: rgba(255, 255, 255, 0.15);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 10px;
        padding: 1rem;
        text-align: center;
        transition: all 0.3s ease;
    }

    .stats-card:hover {
        background: rgba(255, 255, 255, 0.25);
        transform: translateY(-2px);
    }

    .stats-number {
        font-size: 1.75rem;
        font-weight: 800;
        margin-bottom: 0.25rem;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .stats-label {
        font-size: 0.8rem;
        opacity: 0.9;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .action-btn {
        background: rgba(255, 255, 255, 0.2);
        border: 2px solid rgba(255, 255, 255, 0.3);
        color: white;
        padding: 0.625rem 1.25rem;
        border-radius: 50px;
        font-weight: 600;
        font-size: 0.9rem;
        backdrop-filter: blur(10px);
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 0.375rem;
        margin: 0.25rem;
    }

    .action-btn:hover {
        background: white;
        color: #4f46e5;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .filter-section {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        margin: 1.5rem 0;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        border: 1px solid rgba(0, 0, 0, 0.05);
    }

    .filter-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: #4f46e5;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .role-card {
        background: white;
        border-radius: 12px;
        padding: 1rem;
        margin-bottom: 0.875rem;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        border: 1px solid rgba(0, 0, 0, 0.05);
        transition: all 0.3s ease;
        position: relative;
        overflow: visible !important;
        z-index: 1;
    }

    .role-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
        border-color: rgba(79, 70, 229, 0.2);
    }

    .role-card:has(.dropdown.show) {
        z-index: 9999 !important;
        overflow: visible !important;
    }

    .role-card .dropdown {
        position: static !important;
    }

    .role-card .dropdown-menu {
        z-index: 10000 !important;
        position: absolute !important;
    }

    .role-name {
        font-size: 1.1rem;
        font-weight: 600;
        color: #4f46e5;
        margin-bottom: 0.375rem;
    }

    .role-info {
        display: flex;
        align-items: center;
        gap: 0.375rem;
        margin-bottom: 0.375rem;
        color: #6b7280;
        font-size: 0.85rem;
    }

    .permission-badge {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
        padding: 0.25rem 0.5rem;
        border-radius: 15px;
        font-size: 0.75rem;
        font-weight: 600;
        margin-right: 0.25rem;
        display: inline-block;
    }
</style>

<div class="content">
    <!-- Breadcrumb -->
    <nav class="mb-3" aria-label="breadcrumb">
        <ol class="breadcrumb mb-0">
            <li class="breadcrumb-item"><a href="/Home/Index">Home</a></li>
            <li class="breadcrumb-item"><a href="/ManageUsers/Index">Manage Users</a></li>
            <li class="breadcrumb-item active">Roles & Permissions</li>
        </ol>
    </nav>

    <!-- Modern Header with Stats -->
    <div class="modern-header">
        <div class="header-content">
            <div class="row align-items-center">
                <div class="col-lg-8">
                    <div class="d-flex align-items-center">
                        <div class="me-3">
                            <i class="fa-solid fa-shield-halved" style="font-size: 2.5rem; opacity: 0.9;"></i>
                        </div>
                        <div>
                            <h1 class="header-title mb-0">Roles & Permissions</h1>
                            <p class="header-subtitle mb-0">Define and manage user roles with custom permissions</p>
                        </div>
                    </div>
                </div>
                <div class="col-lg-4 text-lg-end">
                    <button type="button" class="action-btn" data-bs-toggle="modal" data-bs-target="#addRoleModal">
                        <i class="fa-solid fa-plus"></i>
                        <span>Add Role</span>
                    </button>
                </div>
            </div>


        </div>
    </div>

    <!-- Filter Section -->
    <div class="filter-section">
        <div class="filter-title">
            <i class="fa-solid fa-filter"></i>
            <span>Filter & Search</span>
        </div>
        <div class="row g-3">
            <div class="col-md-12">
                <label for="searchBox" class="form-label fw-semibold">
                    <i class="fa-solid fa-search text-muted me-2"></i>Search Roles
                </label>
                <input type="text" class="form-control" id="searchBox" 
                       placeholder="Search by role name...">
            </div>
        </div>
        <div class="row mt-3">
            <div class="col-md-12">
                <button type="button" class="btn btn-outline-primary" id="clearFilters">
                    <i class="fa-solid fa-refresh me-1"></i>Clear Filters
                </button>
            </div>
        </div>
    </div>

    <!-- Roles List -->
    <div id="rolesContainer">
        @if (rolesList.Any())
        {
            foreach (var role in rolesList)
            {
                <div class="role-card paginated-item">
                    <div class="row align-items-center">
                        <div class="col-md-4">
                            <div class="role-name">
                                <i class="fa-solid fa-user-tag me-2"></i>@role.RoleName
                            </div>
                            <div class="role-info">
                                <i class="fa-solid fa-calendar"></i>
                                <span>Created: @role.CreatedAt.ToString("MMM dd, yyyy")</span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="role-info">
                                <i class="fa-solid fa-key me-2"></i>
                                <strong>Page-Specific Permissions</strong>
                            </div>
                            <div>
                                <span class="permission-badge">Configured per page</span>
                            </div>
                        </div>
                        <div class="col-md-2 text-end">
                            <div class="dropdown">
                                <button class="btn btn-sm btn-outline-primary" type="button" data-bs-toggle="dropdown">
                                    <i class="fa-solid fa-ellipsis-vertical"></i>
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end">
                                    <li>
                                        <a class="dropdown-item" href="/ManageUsers/RolePermissions?roleName=@role.RoleName">
                                            <i class="fa-solid fa-shield-halved me-2"></i>Manage Permissions
                                        </a>
                                    </li>
                                    <li>
                                        <button class="dropdown-item edit-role-btn" data-role-id="@role.Id">
                                            <i class="fa-solid fa-pencil me-2"></i>Edit Role
                                        </button>
                                    </li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li>
                                        <a class="dropdown-item text-danger" href="/ManageUsers/DeleteRoles/@role.Id" onclick="return confirm('Are you sure you want to delete this role?')">
                                            <i class="fa-solid fa-trash me-2"></i>Delete
                                        </a>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            }
        }
        else
        {
            <div class="text-center py-5">
                <i class="fa-solid fa-shield-halved" style="font-size: 5rem; color: #e9ecef;"></i>
                <h3 class="mt-3">No Roles Found</h3>
                <p class="text-muted">Start by adding your first role</p>
            </div>
        }
        
        <!-- Pagination -->
        <div id="pagination-container" class="mt-4"></div>
    </div>
</div>

<!-- Add Role Modal -->
<div class="modal fade" id="addRoleModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" style="max-width: 600px !important; width: 600px;">
        <div class="modal-content">
            <form id="addRoleForm" method="post" action="/ManageUsers/AddRoles">
                @Html.AntiForgeryToken()
                <div class="modal-header">
                    <h5 class="modal-title">Add New Role</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Role Name</label>
                        <input name="RoleName" class="form-control" placeholder="Enter role name" required />
                    </div>
                    <div class="mb-3">
                        <div class="alert alert-info">
                            <i class="fa-solid fa-info-circle me-2"></i>
                            <strong>Note:</strong> After creating the role, use "Manage Permissions" to set page-specific permissions.
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Role</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Role Modal -->
<div class="modal fade" id="editRoleModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" style="max-width: 600px !important; width: 600px;">
        <div class="modal-content">
            <form id="editRoleForm" method="post" action="/ManageUsers/AddRoles">
                @Html.AntiForgeryToken()
                <input type="hidden" name="Id" id="editRoleId" />
                <div class="modal-header">
                    <h5 class="modal-title">Edit Role</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Role Name</label>
                        <input name="RoleName" id="editRoleName" class="form-control" required />
                    </div>
                    <div class="mb-3">
                        <div class="alert alert-info">
                            <i class="fa-solid fa-info-circle me-2"></i>
                            <strong>Note:</strong> Use "Manage Permissions" to set page-specific permissions for this role.
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
<script>
$(document).ready(function () {
    // Handle dropdown z-index
    $('.role-card .dropdown').on('show.bs.dropdown', function () {
        $('.role-card').css('z-index', '1');
        $(this).closest('.role-card').css('z-index', '9999');
    });

    $('.role-card .dropdown').on('hide.bs.dropdown', function () {
        $(this).closest('.role-card').css('z-index', '1');
    });

    // Search functionality
    function applyFilters() {
        var search = $('#searchBox').val().toLowerCase();

        $('.role-card').each(function () {
            var card = $(this);
            var text = card.text().toLowerCase();
            var matchSearch = !search || text.includes(search);

            if (matchSearch) {
                card.show();
            } else {
                card.hide();
            }
        });
    }

    $('#searchBox').on('input', applyFilters);

    $('#clearFilters').on('click', function () {
        $('#searchBox').val('');
        applyFilters();
    });

    // Add Role form submit
    $('#addRoleForm').on('submit', function (e) {
        e.preventDefault();
        
        const submitBtn = $(this).find('button[type="submit"]');
        const originalText = submitBtn.html();
        submitBtn.prop('disabled', true).html('<i class="fa-solid fa-spinner fa-spin me-2"></i>Creating...');
        
        $.ajax({
            url: $(this).attr('action'),
            type: 'POST',
            data: $(this).serialize(),
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            },
            success: function(response) {
                if (response.success) {
                    $('#addRoleModal').modal('hide');
                    location.reload();
                } else {
                    alert(response.message || 'Error creating role');
                }
            },
            error: function(xhr) {
                let errorMessage = 'Error creating role';
                try {
                    const response = JSON.parse(xhr.responseText);
                    errorMessage = response.message || errorMessage;
                } catch (e) {
                    errorMessage = xhr.responseText || errorMessage;
                }
                alert(errorMessage);
            },
            complete: function() {
                submitBtn.prop('disabled', false).html(originalText);
            }
        });
    });

    // Edit Role button
    $('.edit-role-btn').on('click', function () {
        var roleId = $(this).data('role-id');
        $.getJSON('/ManageUsers/GetRole?id=' + roleId, function (response) {
            if (response.success) {
                $('#editRoleId').val(response.id);
                $('#editRoleName').val(response.roleName);
                $('#editRoleModal').modal('show');
            } else {
                alert(response.message || 'Role not found');
            }
        }).fail(function() {
            alert('Error loading role data');
        });
    });

    // Edit Role form submit
    $('#editRoleForm').on('submit', function (e) {
        e.preventDefault();
        
        const submitBtn = $(this).find('button[type="submit"]');
        const originalText = submitBtn.html();
        submitBtn.prop('disabled', true).html('<i class="fa-solid fa-spinner fa-spin me-2"></i>Saving...');
        
        $.ajax({
            url: $(this).attr('action'),
            type: 'POST',
            data: $(this).serialize(),
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            },
            success: function(response) {
                if (response.success) {
                    $('#editRoleModal').modal('hide');
                    location.reload();
                } else {
                    alert(response.message || 'Error updating role');
                }
            },
            error: function(xhr, status, error) {
                console.log('XHR Status:', xhr.status);
                console.log('Response Text:', xhr.responseText);
                console.log('Error:', error);
                
                let errorMessage = 'Error updating role';
                try {
                    const response = JSON.parse(xhr.responseText);
                    errorMessage = response.message || errorMessage;
                } catch (e) {
                    if (xhr.status === 400) {
                        errorMessage = 'Invalid data provided';
                    } else if (xhr.status === 500) {
                        errorMessage = 'Server error occurred';
                    }
                }
                
                alert(errorMessage);
            },
            complete: function() {
                submitBtn.prop('disabled', false).html(originalText);
            }
        });
    });
});
</script>
}
