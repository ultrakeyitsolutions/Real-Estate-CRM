@{
    ViewData["Title"] = "Complete Payment";
    Layout = null;
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - CRM Payment</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; }
        .payment-container { min-height: 100vh; display: flex; align-items: center; justify-content: center; }
        .payment-card { box-shadow: 0 10px 30px rgba(0,0,0,0.3); border-radius: 15px; }
    </style>
</head>
<body>

<div class="payment-container">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-md-6">
                <div class="card payment-card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0 text-center">
                            <i class="fa-solid fa-credit-card me-2"></i>Complete Your Payment
                        </h5>
                    </div>
                    <div class="card-body text-center" id="paymentContent">
                        <div class="mb-4">
                            <i class="fa-solid fa-spinner fa-spin" style="font-size: 3rem; color: #3b82f6;"></i>
                            <h6 class="mt-3">Loading Payment Details...</h6>
                            <p class="text-muted">Please wait while we fetch your order details</p>
                        </div>
                        
                        <div class="alert alert-info">
                            <strong>Order ID:</strong> @ViewBag.OrderId
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://checkout.razorpay.com/v1/checkout.js" onload="console.log('Razorpay script loaded successfully')" onerror="console.error('Failed to load Razorpay script')"></script>
<script>
const orderId = '@ViewBag.OrderId';

// Wait for Razorpay to load
function waitForRazorpay(callback) {
    if (typeof Razorpay !== 'undefined') {
        callback();
    } else {
        console.log('Waiting for Razorpay to load...');
        setTimeout(() => waitForRazorpay(callback), 100);
    }
}

// Initialize after Razorpay loads
waitForRazorpay(() => {
    console.log('Razorpay is ready, initializing payment page');
    loadOrderDetails();
});

function loadOrderDetails() {
    // Fetch order details and show payment button
    fetch(`/Subscription/GetOrderDetails?orderId=${orderId}`)
        .then(response => {
            console.log('GetOrderDetails response status:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('GetOrderDetails response data:', data);
            if (data.success) {
                showPaymentInterface(data.order);
            } else {
                showError(data.message || 'Failed to load order details');
            }
        })
        .catch(error => {
            console.error('GetOrderDetails error:', error);
            showError('Failed to load payment details');
        });
}

function showPaymentInterface(order) {
    document.getElementById('paymentContent').innerHTML = `
        <div class="mb-4">
            <h4 class="text-primary">â‚¹${(order.amount / 100).toLocaleString()}</h4>
            <p class="text-muted">${order.planName} - ${order.billingCycle}</p>
        </div>
        
        <div class="mb-4">
            <p><strong>Partner:</strong> ${order.partnerEmail}</p>
            <p><strong>Upgrade Type:</strong> ${order.upgradeType}</p>
        </div>
        
        <button class="btn btn-success btn-lg" onclick="initiatePayment()">
            <i class="fa-solid fa-credit-card me-2"></i>Pay Now
        </button>
    `;
}

function showError(message) {
    document.getElementById('paymentContent').innerHTML = `
        <div class="alert alert-danger">
            <i class="fa-solid fa-exclamation-triangle me-2"></i>
            ${message}
        </div>
    `;
}

function initiatePayment() {
    console.log('Initiating payment for orderId:', orderId);
    
    // Check if Razorpay is available
    if (typeof Razorpay === 'undefined') {
        console.error('Razorpay library not loaded');
        alert('Payment system not ready. Please refresh the page and try again.');
        return;
    }
    
    // Fetch fresh order details for payment
    fetch(`/Subscription/GetOrderDetails?orderId=${orderId}`)
        .then(response => {
            console.log('Payment initiation response status:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('Payment initiation response data:', data);
            if (data.success) {
                console.log('Opening Razorpay with options:', {
                    key: data.razorpayKey,
                    amount: data.order.amount,
                    order_id: orderId
                });
                const options = {
                    key: data.razorpayKey,
                    amount: data.order.amount,
                    currency: 'INR',
                    name: 'CRM Upgrade',
                    description: `${data.order.planName} - ${data.order.billingCycle}`,
                    order_id: orderId,
                    handler: function(response) {
                        // Payment successful
                        console.log('Payment successful:', response);
                        window.location.href = `/Subscription/PaymentSuccess?paymentId=${response.razorpay_payment_id}&orderId=${response.razorpay_order_id}`;
                    },
                    prefill: {
                        email: data.order.partnerEmail
                    },
                    theme: {
                        color: '#3b82f6'
                    },
                    modal: {
                        ondismiss: function() {
                            console.log('Payment cancelled by user');
                        }
                    }
                };
                
                const rzp = new Razorpay(options);
                rzp.open();
            } else {
                console.error('Payment initiation failed:', data.message);
                alert('Error: ' + (data.message || 'Failed to initiate payment'));
            }
        })
        .catch(error => {
            console.error('Payment initiation error:', error);
            alert('Failed to initiate payment. Please try again.');
        });
}
</script>

</body>
</html>