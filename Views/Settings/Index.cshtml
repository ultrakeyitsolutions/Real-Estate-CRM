@model Dictionary<string, string>
@{
    ViewData["Title"] = "System Settings";
}

<style>
    .settings-container {
        max-width: 1200px;
        margin: 0 auto;
    }

    .settings-card {
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        transition: all 0.3s ease;
        margin-bottom: 2rem;
    }

    .settings-card:hover {
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12);
    }

    .settings-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 1.5rem;
        border-radius: 12px 12px 0 0;
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .settings-header h4 {
        margin: 0;
        font-weight: 600;
    }

    .settings-body {
        padding: 2rem;
    }

    .form-label {
        font-weight: 600;
        color: #495057;
        margin-bottom: 0.5rem;
        font-size: 0.875rem;
    }

    .form-control, .form-select {
        border-radius: 8px;
        border: 1px solid #dee2e6;
        padding: 0.75rem;
        font-size: 0.875rem;
        transition: all 0.3s ease;
    }

    .form-control:focus, .form-select:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.15);
    }

    .settings-icon {
        width: 40px;
        height: 40px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.25rem;
    }

    .save-btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        padding: 0.875rem 2.5rem;
        border-radius: 8px;
        font-weight: 600;
        font-size: 1rem;
        transition: all 0.3s ease;
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }

    .save-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    }

    .help-text {
        font-size: 0.8rem;
        color: #6c757d;
        margin-top: 0.25rem;
    }

    .input-group-text {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 8px 0 0 8px;
        font-weight: 600;
        color: #495057;
    }

    @@media (max-width: 768px) {
        .settings-body {
            padding: 1rem;
        }

        .save-btn {
            width: 100%;
        }
    }
</style>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<div class="content settings-container">
    <!-- Breadcrumb -->
    <nav class="mb-3" aria-label="breadcrumb">
        <ol class="breadcrumb mb-0">
            <li class="breadcrumb-item"><a href="/Home/Index">Home</a></li>
            <li class="breadcrumb-item active">Settings</li>
        </ol>
    </nav>

    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-1">System Settings</h2>
            <p class="text-muted mb-0">Configure company information and default values</p>
        </div>
        @{
            var currentRole = User?.FindFirst(System.Security.Claims.ClaimTypes.Role)?.Value;
        }
        @if (currentRole == "Admin")
        {
            <div>
                <a href="@Url.Action("Branding", "Settings")" class="btn btn-outline-primary me-2">
                    <i class="fas fa-palette me-2"></i>Landing Page Branding
                </a>
                <a href="@Url.Action("Impersonation", "Settings")" class="btn btn-outline-warning">
                    <i class="fas fa-user-secret me-2"></i>User Impersonation
                </a>
            </div>
        }
    </div>

    <form id="settingsForm">
    @Html.AntiForgeryToken()
        <!-- Company Information Card -->
        <div class="card settings-card">
            <div class="settings-header">
                <div class="settings-icon">
                    <i class="fa-solid fa-building"></i>
                </div>
                <div>
                    <h4>Company Information</h4>
                    <small>Details that appear on quotations, invoices, and receipts</small>
                </div>
            </div>
            <div class="settings-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label for="CompanyName" class="form-label">
                            <i class="fa-solid fa-building text-primary me-2"></i>Company Name *
                        </label>
                        <input type="text" class="form-control" id="CompanyName" name="CompanyName" 
                               value="@(Model.ContainsKey("CompanyName") ? Model["CompanyName"] : "")" 
                               placeholder="Enter company name" required>
                        <div class="help-text">Legal name of your company</div>
                    </div>

                    <div class="col-md-6">
                        <label for="CompanyGST" class="form-label">
                            <i class="fa-solid fa-file-invoice text-primary me-2"></i>GST Number *
                        </label>
                        <input type="text" class="form-control" id="CompanyGST" name="CompanyGST" 
                               value="@(Model.ContainsKey("CompanyGST") ? Model["CompanyGST"] : "")" 
                               placeholder="XX-XXXXX-XXXXX-XX" required>
                        <div class="help-text">15-digit GST identification number</div>
                    </div>

                    <div class="col-md-6">
                        <label for="CompanyAddress" class="form-label">
                            <i class="fa-solid fa-location-dot text-primary me-2"></i>Address *
                        </label>
                        <textarea class="form-control" id="CompanyAddress" name="CompanyAddress" 
                                  rows="3" placeholder="Enter complete address" required>@(Model.ContainsKey("CompanyAddress") ? Model["CompanyAddress"] : "")</textarea>
                        <div class="help-text">Complete office address with pincode</div>
                    </div>

                    <div class="col-md-6">
                        <label for="CompanyMapUrl" class="form-label">
                            <i class="fa-solid fa-map text-primary me-2"></i>Map URL
                        </label>
                        <input type="url" class="form-control" id="CompanyMapUrl" name="CompanyMapUrl" 
                               value="@(Model.ContainsKey("CompanyMapUrl") ? Model["CompanyMapUrl"] : "")" 
                               placeholder="https://maps.google.com/...">
                        <div class="help-text">Google Maps or other map service URL</div>
                    </div>

                    <div class="col-md-6">
                        <label for="CompanyPhone" class="form-label">
                            <i class="fa-solid fa-phone text-primary me-2"></i>Phone Number *
                        </label>
                        <input type="text" class="form-control" id="CompanyPhone" name="CompanyPhone" 
                               value="@(Model.ContainsKey("CompanyPhone") ? Model["CompanyPhone"] : "")" 
                               placeholder="+91-XXXXXXXXXX" required>
                        <div class="help-text">Primary contact number</div>
                    </div>

                    <div class="col-md-6">
                        <label for="CompanyEmail" class="form-label">
                            <i class="fa-solid fa-envelope text-primary me-2"></i>Email Address *
                        </label>
                        <input type="email" class="form-control" id="CompanyEmail" name="CompanyEmail" 
                               value="@(Model.ContainsKey("CompanyEmail") ? Model["CompanyEmail"] : "")" 
                               placeholder="info@company.com" required>
                        <div class="help-text">Official email for correspondence</div>
                    </div>

                    <div class="col-md-6">
                        <label for="CompanyLogo" class="form-label">
                            <i class="fa-solid fa-image text-primary me-2"></i>Company Logo
                        </label>
                        <input type="file" class="form-control" id="CompanyLogo" name="CompanyLogo" 
                               accept="image/png,image/jpeg,image/jpg,image/gif">
                        <div class="help-text">Upload logo (PNG, JPG, GIF - Max 2MB)</div>
                    </div>

                    <div class="col-md-6">
                        <label for="CollapsedLogo" class="form-label">
                            <i class="fa-solid fa-compress text-primary me-2"></i>Collapsed Sidebar Logo
                        </label>
                        <input type="file" class="form-control" id="CollapsedLogo" name="CollapsedLogo" 
                               accept="image/png,image/jpeg,image/jpg,image/gif">
                        <div class="help-text">Small logo for collapsed sidebar (PNG, JPG, GIF - Max 2MB)</div>
                    </div>

                    <div class="col-md-6">
                        @if (Model.ContainsKey("CompanyLogo") && !string.IsNullOrEmpty(Model["CompanyLogo"]))
                        {
                            <label class="form-label">Current Logo</label>
                            <div class="border rounded p-3 bg-light" style="max-width: 300px;">
                                <img src="@Model["CompanyLogo"]" alt="Company Logo" class="img-fluid" style="max-height: 100px;" id="currentLogo">
                                <button type="button" class="btn btn-sm btn-danger mt-2" id="removeLogo">
                                    <i class="fa-solid fa-trash me-1"></i>Remove Logo
                                </button>
                            </div>
                        }
                        else
                        {
                            <label class="form-label">Logo Preview</label>
                            <div class="border rounded p-3 bg-light" style="max-width: 300px; min-height: 100px; display: flex; align-items: center; justify-content: center;">
                                <span class="text-muted">No logo uploaded</span>
                            </div>
                        }
                    </div>

                    <div class="col-md-6">
                        @if (Model.ContainsKey("CollapsedLogo") && !string.IsNullOrEmpty(Model["CollapsedLogo"]))
                        {
                            <label class="form-label">Current Collapsed Logo</label>
                            <div class="border rounded p-3 bg-light" style="max-width: 200px;">
                                <img src="@Model["CollapsedLogo"]" alt="Collapsed Logo" class="img-fluid" style="max-height: 60px;" id="currentCollapsedLogo">
                                <button type="button" class="btn btn-sm btn-danger mt-2" id="removeCollapsedLogo">
                                    <i class="fa-solid fa-trash me-1"></i>Remove
                                </button>
                            </div>
                        }
                        else
                        {
                            <label class="form-label">Collapsed Logo Preview</label>
                            <div class="border rounded p-3 bg-light" style="max-width: 200px; min-height: 80px; display: flex; align-items: center; justify-content: center;">
                                <span class="text-muted">No collapsed logo</span>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>

        <!-- Financial Configuration Card -->
        <div class="card settings-card">
            <div class="settings-header">
                <div class="settings-icon">
                    <i class="fa-solid fa-indian-rupee-sign"></i>
                </div>
                <div>
                    <h4>Financial Configuration</h4>
                    <small>Tax rates and payment defaults</small>
                </div>
            </div>
            <div class="settings-body">
                <div class="row g-3">
                    <div class="col-md-4">
                        <label for="GSTRate" class="form-label">
                            <i class="fa-solid fa-percent text-success me-2"></i>GST Rate (%) *
                        </label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="GSTRate" name="GSTRate" 
                                   value="@(Model.ContainsKey("GSTRate") ? Model["GSTRate"] : "5")" 
                                   step="0.01" min="0" max="100" required>
                            <span class="input-group-text">%</span>
                        </div>
                        <div class="help-text">Applied on all invoices</div>
                    </div>

                    <div class="col-md-4">
                        <label for="BookingPercentage" class="form-label">
                            <i class="fa-solid fa-percent text-warning me-2"></i>Default Booking (%) *
                        </label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="BookingPercentage" name="BookingPercentage" 
                                   value="@(Model.ContainsKey("BookingPercentage") ? Model["BookingPercentage"] : "20")" 
                                   step="1" min="0" max="100" required>
                            <span class="input-group-text">%</span>
                        </div>
                        <div class="help-text">Initial payment percentage</div>
                    </div>

                    <div class="col-md-4">
                        <label for="EMIStructure" class="form-label">
                            <i class="fa-solid fa-chart-line text-info me-2"></i>EMI Structure *
                        </label>
                        <input type="text" class="form-control" id="EMIStructure" name="EMIStructure" 
                               value="@(Model.ContainsKey("EMIStructure") ? Model["EMIStructure"] : "20-30-30-20")" 
                               placeholder="20-30-30-20" required>
                        <div class="help-text">Percentages separated by hyphen</div>
                    </div>

                    <div class="col-12">
                        <div class="alert alert-info d-flex align-items-start">
                            <i class="fa-solid fa-info-circle me-2 mt-1"></i>
                            <div>
                                <strong>EMI Structure Example:</strong> 20-30-30-20 means:
                                <ul class="mb-0 mt-2">
                                    <li>20% at Booking</li>
                                    <li>30% at Agreement</li>
                                    <li>30% at Foundation/Construction</li>
                                    <li>20% at Possession</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Facebook API Configuration Card -->
        <div class="card settings-card">
            <div class="settings-header">
                <div class="settings-icon">
                    <i class="fa-brands fa-facebook"></i>
                </div>
                <div>
                    <h4>Facebook API Configuration</h4>
                    <small>Settings for Facebook Lead Ads integration</small>
                </div>
            </div>
            <div class="settings-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label for="FB_ACCESS_TOKEN" class="form-label">
                            <i class="fa-solid fa-key text-primary me-2"></i>Facebook Access Token *
                        </label>
                        <input type="password" class="form-control" id="FB_ACCESS_TOKEN" name="FB_ACCESS_TOKEN" 
                               value="@(Model.ContainsKey("FB_ACCESS_TOKEN") ? Model["FB_ACCESS_TOKEN"] : "")" 
                               placeholder="Enter Facebook Access Token">
                        <div class="help-text">Long-lived access token from Facebook Developer Console</div>
                    </div>

                    <div class="col-md-6">
                        <label for="FB_AD_ID" class="form-label">
                            <i class="fa-solid fa-bullhorn text-primary me-2"></i>Facebook Ad ID *
                        </label>
                        <input type="text" class="form-control" id="FB_AD_ID" name="FB_AD_ID" 
                               value="@(Model.ContainsKey("FB_AD_ID") ? Model["FB_AD_ID"] : "")" 
                               placeholder="Enter Facebook Ad ID">
                        <div class="help-text">ID of the Facebook Lead Ad campaign</div>
                    </div>

                    <div class="col-12">
                        <div class="alert alert-info d-flex align-items-start">
                            <i class="fa-solid fa-info-circle me-2 mt-1"></i>
                            <div>
                                <strong>Facebook API Setup:</strong>
                                <ul class="mb-0 mt-2">
                                    <li>Create a Facebook App in <a href="https://developers.facebook.com/" target="_blank">Facebook Developer Console</a></li>
                                    <li>Generate a long-lived access token with <code>leads_retrieval</code> permission</li>
                                    <li>Get the Ad ID from your Facebook Ads Manager</li>
                                    <li>Test the connection using the API endpoint: <code>/api/facebook/fetch-leads</code></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Document Numbering Card -->
        <div class="card settings-card">
            <div class="settings-header">
                <div class="settings-icon">
                    <i class="fa-solid fa-hashtag"></i>
                </div>
                <div>
                    <h4>Document Numbering</h4>
                    <small>Prefixes for automatic number generation</small>
                </div>
            </div>
            <div class="settings-body">
                <div class="row g-3">
                    <div class="col-md-4">
                        <label for="InvoicePrefix" class="form-label">
                            <i class="fa-solid fa-file-invoice text-primary me-2"></i>Invoice Prefix *
                        </label>
                        <input type="text" class="form-control" id="InvoicePrefix" name="InvoicePrefix" 
                               value="@(Model.ContainsKey("InvoicePrefix") ? Model["InvoicePrefix"] : "INV")" 
                               placeholder="INV" required>
                        <div class="help-text">Format: INV-2025-0001</div>
                    </div>

                    <div class="col-md-4">
                        <label for="QuotationPrefix" class="form-label">
                            <i class="fa-solid fa-file-lines text-success me-2"></i>Quotation Prefix *
                        </label>
                        <input type="text" class="form-control" id="QuotationPrefix" name="QuotationPrefix" 
                               value="@(Model.ContainsKey("QuotationPrefix") ? Model["QuotationPrefix"] : "QT")" 
                               placeholder="QT" required>
                        <div class="help-text">Format: QT-2025-0001</div>
                    </div>

                    <div class="col-md-4">
                        <label for="BookingPrefix" class="form-label">
                            <i class="fa-solid fa-book text-warning me-2"></i>Booking Prefix *
                        </label>
                        <input type="text" class="form-control" id="BookingPrefix" name="BookingPrefix" 
                               value="@(Model.ContainsKey("BookingPrefix") ? Model["BookingPrefix"] : "BK")" 
                               placeholder="BK" required>
                        <div class="help-text">Format: BK-2025-0001</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Save Button -->
        <div class="text-end mb-5">
            <button type="submit" class="btn btn-primary save-btn">
                <i class="fa-solid fa-save me-2"></i>Save All Settings
            </button>
        </div>
    </form>
</div>

<script>
    $(document).ready(function() {
        // Logo preview on file select
        $('#CompanyLogo').on('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                // Validate file size (2MB)
                if (file.size > 2 * 1024 * 1024) {
                    Swal.fire({
                        icon: 'error',
                        title: 'File Too Large',
                        text: 'Logo file must be less than 2MB'
                    });
                    $(this).val('');
                    return;
                }

                // Validate file type
                const validTypes = ['image/png', 'image/jpeg', 'image/jpg', 'image/gif'];
                if (!validTypes.includes(file.type)) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Invalid File Type',
                        text: 'Please upload a PNG, JPG, or GIF image'
                    });
                    $(this).val('');
                    return;
                }

                // Show preview
                const reader = new FileReader();
                reader.onload = function(e) {
                    $('#currentLogo').attr('src', e.target.result);
                };
                reader.readAsDataURL(file);
            }
        });

        // Remove logo button
        $('#removeLogo').on('click', function() {
            Swal.fire({
                title: 'Remove Logo?',
                text: 'Are you sure you want to remove the company logo?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Yes, remove it',
                cancelButtonText: 'Cancel'
            }).then((result) => {
                if (result.isConfirmed) {
                    $.ajax({
                        url: '/Settings/RemoveLogo',
                        type: 'POST',
                        data: {
                            __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
                        },
                        success: function(response) {
                            if (response.success) {
                                Swal.fire({
                                    icon: 'success',
                                    title: 'Logo Removed',
                                    text: 'Company logo has been removed',
                                    timer: 2000
                                }).then(() => {
                                    location.reload();
                                });
                            }
                        }
                    });
                }
            });
        });

        // Form submission with file upload
        $('#settingsForm').on('submit', function(e) {
            e.preventDefault();
            const submitBtn = $(this).find('button[type="submit"]');
            const originalText = submitBtn.html();
            submitBtn.prop('disabled', true).html('<i class="fa-solid fa-spinner fa-spin me-2"></i>Saving...');

            // Create FormData for file upload
            const formData = new FormData(this);
            


            // Submit via AJAX with file support
            $.ajax({
                url: '/Settings/UpdateSettings',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function(response) {
                    if (response.success) {
                        Swal.fire({
                            icon: 'success',
                            title: 'Success!',
                            text: 'Settings updated successfully',
                            timer: 2000,
                            showConfirmButton: false
                        }).then(() => {
                            location.reload();
                        });
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: response.message || 'Failed to update settings'
                        });
                    }
                },
                error: function(xhr, status, error) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'An error occurred while saving settings'
                    });
                },
                complete: function() {
                    submitBtn.prop('disabled', false).html(originalText);
                }
            });
        });
        
        // Validate EMI structure format
        $('#EMIStructure').on('blur', function() {
            const value = $(this).val();
            const parts = value.split('-');
            
            // Check if format is correct
            if (parts.length < 2) {
                $(this).addClass('is-invalid');
                if (!$(this).next('.invalid-feedback').length) {
                    $(this).after('<div class="invalid-feedback">EMI structure must have at least 2 parts separated by hyphen (e.g., 20-80 or 20-30-30-20)</div>');
                }
                return;
            }
            
            // Check if all parts are numbers
            let total = 0;
            for (let part of parts) {
                const num = parseFloat(part);
                if (isNaN(num)) {
                    $(this).addClass('is-invalid');
                    if (!$(this).next('.invalid-feedback').length) {
                        $(this).after('<div class="invalid-feedback">All parts must be valid numbers</div>');
                    }
                    return;
                }
                total += num;
            }
            
            // Check if total is approximately 100
            if (Math.abs(total - 100) > 0.01) {
                $(this).addClass('is-invalid');
                if (!$(this).next('.invalid-feedback').length) {
                    $(this).after('<div class="invalid-feedback">Total must equal 100% (Current: ' + total + '%)</div>');
                }
                return;
            }
            
            // Valid
            $(this).removeClass('is-invalid');
            $(this).next('.invalid-feedback').remove();
        });


    });
</script>


