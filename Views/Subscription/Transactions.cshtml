@model IEnumerable<CRM.Models.PaymentTransactionModel>
@using Microsoft.EntityFrameworkCore
@inject CRM.AppDbContext DbContext
@{
    ViewData["Title"] = "Subscription Transactions";
    var isAdmin = ViewBag.IsAdmin ?? false;
    
    // Get card details for pending refund subscriptions
    var pendingRefundSubs = ViewBag.PendingRefundSubscriptions as List<CRM.Models.PartnerSubscriptionModel> ?? new List<CRM.Models.PartnerSubscriptionModel>();
    var subscriptionIds = pendingRefundSubs.Select(s => s.SubscriptionId).ToList();
    var paymentTransactionsForRefunds = DbContext.PaymentTransactions
        .Where(t => t.SubscriptionId.HasValue && subscriptionIds.Contains(t.SubscriptionId.Value) && t.Status == "Success")
        .ToDictionary(t => t.SubscriptionId!.Value, t => t);
}

<style>
    .transaction-card {
        background: var(--bs-body-bg, white);
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1rem;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        border: 1px solid var(--bs-border-color, rgba(0, 0, 0, 0.05));
        transition: all 0.3s ease;
    }

    .transaction-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    }

    .transaction-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 1rem;
        gap: 1rem;
    }

    .transaction-id {
        font-weight: 600;
        color: var(--bs-body-color, #1e293b);
        font-size: 1.1rem;
        word-break: break-all;
        max-width: 300px;
    }

    .transaction-amount {
        font-size: 1.5rem;
        font-weight: 700;
        color: #059669;
        white-space: nowrap;
    }

    .transaction-details {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 1rem;
    }

    .detail-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.9rem;
        color: var(--bs-secondary-color, #64748b);
    }

    .detail-item i {
        width: 16px;
        text-align: center;
        color: var(--bs-secondary-color, #94a3b8);
    }

    .status-badge {
        padding: 0.375rem 0.75rem;
        border-radius: 20px;
        font-weight: 600;
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .status-success { 
        background: #dcfce7; 
        color: #166534; 
    }
    
    /* Override global dark mode styles for success badges */
    .dark-mode [data-bs-theme="dark"] .status-success,
    .dark-mode .status-success,
    [data-bs-theme="dark"] .status-success,
    [data-bs-theme="dark"] .status-badge.status-success,
    .dark-mode .status-badge.status-success {
        background-color: #22c55e !important;
        color: #ffffff !important;
        border: none !important;
    }
    
    /* Override global dark mode styles for payment/upgrade badges */
    .dark-mode [data-bs-theme="dark"] .type-payment,
    .dark-mode .type-payment,
    [data-bs-theme="dark"] .type-payment,
    [data-bs-theme="dark"] .type-badge.type-payment,
    .dark-mode .type-badge.type-payment,
    [data-bs-theme="dark"] .type-badge.type-upgrade,
    .dark-mode .type-badge.type-upgrade {
        background-color: #22c55e !important;
        color: #ffffff !important;
        border: none !important;
    }
    
    .status-pending { background: #fef3c7; color: #92400e; }
    .status-failed { background: #fee2e2; color: #991b1b; }
    .status-cancelled { background: #f1f5f9; color: #475569; }
    .status-refunded { background: #e0e7ff; color: #3730a3; }
    
    [data-bs-theme="dark"] .status-pending {
        background: #ffffff !important;
        color: #92400e !important;
        border: 1px solid #92400e;
    }
    
    [data-bs-theme="dark"] .status-failed {
        background: #ffffff !important;
        color: #991b1b !important;
        border: 1px solid #991b1b;
    }
    
    [data-bs-theme="dark"] .status-cancelled {
        background: #ffffff !important;
        color: #475569 !important;
        border: 1px solid #475569;
    }
    
    [data-bs-theme="dark"] .status-refunded {
        background: #ffffff !important;
        color: #3730a3 !important;
        border: 1px solid #3730a3;
    }

    .type-badge {
        padding: 0.25rem 0.5rem;
        border-radius: 12px;
        font-weight: 500;
        font-size: 0.75rem;
        background: var(--bs-secondary-bg, #f1f5f9);
        color: var(--bs-secondary-color, #475569);
    }

    .type-payment { 
        background: #dcfce7; 
        color: #166534; 
    }
    

    
    .type-refund { background: #fee2e2; color: #991b1b; }
    .type-upgrade { background: #dbeafe; color: #1e40af; }
    .type-downgrade { background: #fef3c7; color: #92400e; }
    
    [data-bs-theme="dark"] .type-refund {
        background: #ffffff !important;
        color: #991b1b !important;
        border: 1px solid #991b1b;
    }
    
    [data-bs-theme="dark"] .type-upgrade {
        background: #ffffff !important;
        color: #1e40af !important;
        border: 1px solid #1e40af;
    }
    
    [data-bs-theme="dark"] .type-downgrade {
        background: #ffffff !important;
        color: #92400e !important;
        border: 1px solid #92400e;
    }

    /* Refund Pending Cards */
    .refund-pending-card {
        border: 2px solid #f97316 !important;
        background: linear-gradient(135deg, #fff7ed 0%, #ffffff 100%);
    }
    
    [data-bs-theme="dark"] .refund-pending-card,
    [data-bs-theme="dark"] .transaction-card.refund-pending-card,
    .dark-mode .refund-pending-card,
    .dark-mode .transaction-card.refund-pending-card {
        background: linear-gradient(135deg, #4f3325 0%, #5e2a2a 100%) !important;
        border: 3px solid #7c5235 !important;
        box-shadow: 0 4px 20px rgba(249, 115, 22, 0.5) !important;
    }

    /* Light mode badge and amount styles for refund cards */
    .refund-pending-card .refund-type-badge {
        background: #fed7aa;
        color: #9a3412;
        font-weight: 600;
    }

    .refund-pending-card .refund-status-badge {
        background: #f97316;
        color: white;
        font-weight: 600;
    }

    .refund-pending-card .refund-amount {
        color: #f97316;
    }

    .refund-pending-card .currency-text {
        font-size: 0.875rem;
    }

    .refund-pending-card .refund-alert {
        background: #fff7ed;
        border-color: #f97316;
    }

    .refund-pending-card .refund-alert-text {
        color: #9a3412;
        font-weight: 500;
    }

    /* Dark mode support for refund pending card text - SUPER AGGRESSIVE */
    [data-bs-theme="dark"] .transaction-card.refund-pending-card *,
    .dark-mode .transaction-card.refund-pending-card * {
        color: #ffffff !important;
    }

    [data-bs-theme="dark"] .transaction-card.refund-pending-card .transaction-id,
    [data-bs-theme="dark"] .transaction-card.refund-pending-card .transaction-amount,
    [data-bs-theme="dark"] .transaction-card.refund-pending-card .refund-amount,
    .dark-mode .transaction-card.refund-pending-card .transaction-id,
    .dark-mode .transaction-card.refund-pending-card .transaction-amount,
    .dark-mode .transaction-card.refund-pending-card .refund-amount {
        color: #ffffff !important;
        opacity: 1 !important;
    }

    [data-bs-theme="dark"] .transaction-card.refund-pending-card .detail-item,
    [data-bs-theme="dark"] .transaction-card.refund-pending-card .detail-item span,
    .dark-mode .transaction-card.refund-pending-card .detail-item,
    .dark-mode .transaction-card.refund-pending-card .detail-item span {
        color: #ffffff !important;
        opacity: 1 !important;
    }

    [data-bs-theme="dark"] .transaction-card.refund-pending-card .detail-item i,
    .dark-mode .transaction-card.refund-pending-card .detail-item i {
        color: #ffffff !important;
        opacity: 1 !important;
    }

    [data-bs-theme="dark"] .transaction-card.refund-pending-card .text-muted,
    [data-bs-theme="dark"] .transaction-card.refund-pending-card small.text-muted,
    [data-bs-theme="dark"] .transaction-card.refund-pending-card .text-muted small,
    [data-bs-theme="dark"] .transaction-card.refund-pending-card .currency-text,
    [data-bs-theme="dark"] .transaction-card.refund-pending-card div,
    [data-bs-theme="dark"] .transaction-card.refund-pending-card span,
    [data-bs-theme="dark"] .transaction-card.refund-pending-card small,
    .dark-mode .transaction-card.refund-pending-card .text-muted,
    .dark-mode .transaction-card.refund-pending-card small.text-muted,
    .dark-mode .transaction-card.refund-pending-card .currency-text,
    .dark-mode .transaction-card.refund-pending-card div,
    .dark-mode .transaction-card.refund-pending-card span,
    .dark-mode .transaction-card.refund-pending-card small {
        color: #ffffff !important;
        opacity: 1 !important;
    }

    [data-bs-theme="dark"] .transaction-card.refund-pending-card div.text-muted,
    .dark-mode .transaction-card.refund-pending-card div.text-muted {
        color: #ffffff !important;
        opacity: 1 !important;
    }

    [data-bs-theme="dark"] .transaction-card.refund-pending-card .alert-warning,
    [data-bs-theme="dark"] .transaction-card.refund-pending-card .refund-alert,
    .dark-mode .transaction-card.refund-pending-card .alert-warning,
    .dark-mode .transaction-card.refund-pending-card .refund-alert {
        background: rgba(251, 146, 60, 0.3) !important;
        color: #ffffff !important;
        border-color: #f97316 !important;
    }

    [data-bs-theme="dark"] .transaction-card.refund-pending-card .alert-warning *,
    [data-bs-theme="dark"] .transaction-card.refund-pending-card .alert-warning small,
    [data-bs-theme="dark"] .transaction-card.refund-pending-card .refund-alert *,
    [data-bs-theme="dark"] .transaction-card.refund-pending-card .refund-alert-text,
    .dark-mode .transaction-card.refund-pending-card .alert-warning *,
    .dark-mode .transaction-card.refund-pending-card .alert-warning small,
    .dark-mode .transaction-card.refund-pending-card .refund-alert *,
    .dark-mode .transaction-card.refund-pending-card .refund-alert-text {
        color: #ffffff !important;
        opacity: 1 !important;
        font-weight: 500 !important;
    }

    [data-bs-theme="dark"] .transaction-card.refund-pending-card .type-badge,
    [data-bs-theme="dark"] .transaction-card.refund-pending-card .refund-type-badge,
    .dark-mode .transaction-card.refund-pending-card .type-badge,
    .dark-mode .transaction-card.refund-pending-card .refund-type-badge {
        color: #9a3412 !important;
        background: #fed7aa !important;
        opacity: 1 !important;
    }

    [data-bs-theme="dark"] .transaction-card.refund-pending-card .status-badge,
    [data-bs-theme="dark"] .transaction-card.refund-pending-card .refund-status-badge,
    .dark-mode .transaction-card.refund-pending-card .status-badge,
    .dark-mode .transaction-card.refund-pending-card .refund-status-badge {
        background: #f97316 !important;
        color: white !important;
        opacity: 1 !important;
    }

    /* Pending Refunds heading */
    .pending-refunds-heading {
        color: #f97316 !important;
        font-weight: 700;
    }

    .filter-section {
        background: var(--bs-body-bg, white);
        border-radius: 16px;
        padding: 2rem;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        margin-bottom: 2rem;
        border: 1px solid var(--bs-border-color, transparent);
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .stats-card {
        background: var(--bs-body-bg, white);
        border-radius: 12px;
        padding: 1.5rem;
        text-align: center;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        border: 1px solid var(--bs-border-color, rgba(0, 0, 0, 0.05));
    }

    .stats-number {
        font-size: 2rem;
        font-weight: 800;
        color: var(--bs-body-color, #1e293b);
        margin-bottom: 0.5rem;
    }

    .stats-label {
        font-size: 0.875rem;
        color: var(--bs-secondary-color, #64748b);
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .header-section {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
        padding: 2rem;
        border-radius: 16px;
        margin-bottom: 2rem;
    }

    .export-buttons {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
    }

    .btn-export {
        padding: 0.5rem 1rem;
        border-radius: 8px;
        font-size: 0.875rem;
        font-weight: 500;
        border: 1px solid var(--bs-border-color, #e2e8f0);
        background: var(--bs-body-bg, white);
        color: var(--bs-body-color, #374151);
        text-decoration: none;
        transition: all 0.2s ease;
    }

    .btn-export:hover {
        background: var(--bs-secondary-bg, #f8fafc);
        border-color: var(--bs-border-color, #cbd5e1);
        color: var(--bs-body-color, #1e293b);
    }
    
    /* Dark mode overrides for export buttons */
    [data-bs-theme="dark"] .btn-export:hover {
        background: rgba(255, 255, 255, 0.1) !important;
        border-color: var(--bs-border-color) !important;
        color: #ffffff !important;
    }
    
    [data-bs-theme="dark"] .btn-export:hover *,
    [data-bs-theme="dark"] .btn-export:hover i,
    [data-bs-theme="dark"] .btn-export:hover span {
        color: #ffffff !important;
    }
    
    .dark-mode .btn-export:hover,
    .dark-mode .btn-export:hover *,
    .dark-mode .btn-export:hover i,
    .dark-mode .btn-export:hover span {
        background: rgba(255, 255, 255, 0.1) !important;
        color: #ffffff !important;
    }

    .empty-state {
        text-align: center;
        padding: 4rem 2rem;
        background: var(--bs-body-bg, white);
        border-radius: 16px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        border: 1px solid var(--bs-border-color, transparent);
    }

    .empty-state i {
        font-size: 4rem;
        color: var(--bs-secondary-color, #e5e7eb);
        margin-bottom: 1.5rem;
    }

    /* Mobile responsive styles */
    @@media (max-width: 768px) {
        .transaction-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 0.75rem;
        }
        
        .transaction-id {
            font-size: 1rem;
            max-width: 100%;
        }
        
        .transaction-amount {
            font-size: 1.25rem;
            align-self: flex-end;
        }
        
        .transaction-details {
            grid-template-columns: 1fr;
            gap: 0.5rem;
        }
        
        .stats-grid {
            grid-template-columns: repeat(2, 1fr);
        }
        
        .filter-section {
            padding: 1rem;
        }
        
        .header-section {
            padding: 1.5rem;
        }
        
        .header-section h1 {
            font-size: 1.75rem !important;
        }
        
        .export-buttons {
            justify-content: center;
            margin-top: 1rem;
        }
    }
</style>

<!-- Hidden form for CSRF token -->
@Html.AntiForgeryToken()

<div class="content">
    <!-- Breadcrumb -->
    <nav class="mb-3" aria-label="breadcrumb">
        <ol class="breadcrumb mb-0">
            <li class="breadcrumb-item"><a href="/Home/Index">Home</a></li>
            <li class="breadcrumb-item active">Subscription Transactions</li>
        </ol>
    </nav>

    <!-- Header Section -->
    <div class="header-section">
        <div class="row align-items-center">
            <div class="col-lg-8">
                <div class="d-flex align-items-center mb-3">
                    <div class="me-3">
                        <i class="fa-solid fa-credit-card" style="font-size: 2.5rem; opacity: 0.9;"></i>
                    </div>
                    <div>
                        <h1 class="mb-0" style="font-size: 2.5rem; font-weight: 700;">Subscription Transactions</h1>
                        <p class="mb-0" style="font-size: 1.1rem; opacity: 0.9;">
                            @if (isAdmin)
                            {
                                <span>Monitor all partner subscription payments and transactions</span>
                            }
                            else
                            {
                                <span>View your subscription payment history and transactions</span>
                            }
                        </p>
                    </div>
                </div>
            </div>
            <div class="col-lg-4 text-lg-end">
                <div class="export-buttons">
                    <a href="/Subscription/ExportTransactions?format=excel&status=@ViewBag.Status&type=@ViewBag.Type&fromDate=@ViewBag.FromDate&toDate=@ViewBag.ToDate" class="btn-export">
                        <i class="fa-solid fa-file-excel me-1"></i>Excel
                    </a>
                    <a href="/Subscription/ExportTransactions?format=csv&status=@ViewBag.Status&type=@ViewBag.Type&fromDate=@ViewBag.FromDate&toDate=@ViewBag.ToDate" class="btn-export">
                        <i class="fa-solid fa-file-csv me-1"></i>CSV
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics -->
    <div class="stats-grid">
        <div class="stats-card">
            <div class="stats-number">@Model.Count()</div>
            <div class="stats-label">Total Transactions</div>
        </div>
        <div class="stats-card">
            <div class="stats-number">@Model.Count(t => t.Status == "Success")</div>
            <div class="stats-label">Successful</div>
        </div>
        <div class="stats-card">
            @{
                var totalPayments = Model.Where(t => t.Status == "Success" && t.TransactionType != "Refund").Sum(t => t.Amount);
                var totalRefunds = Model.Where(t => t.Status == "Success" && t.TransactionType == "Refund").Sum(t => t.Amount);
                var netRevenue = totalPayments - totalRefunds;
            }
            <div class="stats-number">₹@netRevenue.ToString("N0")</div>
            <div class="stats-label">Net Revenue</div>
            @if (totalRefunds > 0)
            {
                <small class="text-muted d-block mt-1" style="font-size: 0.75rem;">
                    Payments: ₹@totalPayments.ToString("N0") | Refunds: -₹@totalRefunds.ToString("N0")
                </small>
            }
        </div>
        <div class="stats-card">
            <div class="stats-number">@Model.Count(t => t.Status == "Pending")</div>
            <div class="stats-label">Pending</div>
        </div>
    </div>

    <!-- Filter Section -->
    <div class="filter-section">
        <form method="get" action="/Subscription/Transactions">
            <div class="row g-3">
                <div class="col-md-3">
                    <label class="form-label fw-semibold">Status</label>
                    @{
                        var statusValue = ViewBag.Status?.ToString() ?? "";
                    }
                    <select name="status" class="form-select" onchange="autoSubmitForm()">
                        <option value="">All Status</option>
                        <option value="Success" selected="@(statusValue == "Success")">Success</option>
                        <option value="Pending" selected="@(statusValue == "Pending")">Pending</option>
                        <option value="Failed" selected="@(statusValue == "Failed")">Failed</option>
                        <option value="Cancelled" selected="@(statusValue == "Cancelled")">Cancelled</option>
                        <option value="Refunded" selected="@(statusValue == "Refunded")">Refunded</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label fw-semibold">Type</label>
                    @{
                        var typeValue = ViewBag.Type?.ToString() ?? "";
                    }
                    <select name="type" class="form-select" onchange="autoSubmitForm()">
                        <option value="">All Types</option>
                        <option value="Payment" selected="@(typeValue == "Payment")">Payment</option>
                        <option value="Refund" selected="@(typeValue == "Refund")">Refund</option>
                        <option value="Upgrade" selected="@(typeValue == "Upgrade")">Upgrade</option>
                        <option value="Downgrade" selected="@(typeValue == "Downgrade")">Downgrade</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label fw-semibold">From Date</label>
                    <input type="date" name="fromDate" class="form-control" value="@ViewBag.FromDate" onchange="autoSubmitForm()" />
                </div>
                <div class="col-md-3">
                    <label class="form-label fw-semibold">To Date</label>
                    <input type="date" name="toDate" class="form-control" value="@ViewBag.ToDate" onchange="autoSubmitForm()" />
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-md-6">
                    <button type="submit" class="btn btn-primary me-2">
                        <i class="fa-solid fa-filter me-1"></i>Apply Filters
                    </button>
                    <a href="/Subscription/Transactions" class="btn btn-outline-secondary">
                        <i class="fa-solid fa-refresh me-1"></i>Clear
                    </a>
                </div>
                <div class="col-md-6 text-end">
                    <div class="btn-group">
                        <button type="button" class="btn btn-outline-primary dropdown-toggle" data-bs-toggle="dropdown">
                            <i class="fa-solid fa-calendar me-1"></i>Quick Filters
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="?fromDate=@DateTime.Now.AddDays(-7).ToString("yyyy-MM-dd")">Last 7 days</a></li>
                            <li><a class="dropdown-item" href="?fromDate=@DateTime.Now.AddDays(-30).ToString("yyyy-MM-dd")">Last 30 days</a></li>
                            <li><a class="dropdown-item" href="?fromDate=@DateTime.Now.AddDays(-90).ToString("yyyy-MM-dd")">Last 3 months</a></li>
                            <li><a class="dropdown-item" href="?fromDate=@DateTime.Now.AddYears(-1).ToString("yyyy-MM-dd")">Last year</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </form>
    </div>

    <!-- Transactions List -->
    <div id="transactionsContainer">
        @{
            var pendingRefundSubscriptions = ViewBag.PendingRefundSubscriptions as List<CRM.Models.PartnerSubscriptionModel> ?? new List<CRM.Models.PartnerSubscriptionModel>();
        }
        
        @* Display Pending Refund Subscriptions as Transaction Cards *@
        @if (pendingRefundSubscriptions.Any())
        {
            <div class="mb-3">
                <h5 class="mb-3 pending-refunds-heading">
                    <i class="fa-solid fa-exclamation-triangle me-2"></i>Pending Refunds
                </h5>
            </div>
            
            @foreach (var subscription in pendingRefundSubs)
            {
                // Get card details for this subscription
                var hasCardDetails = paymentTransactionsForRefunds.TryGetValue(subscription.SubscriptionId, out var paymentTxn);
                var cardInfo = hasCardDetails && paymentTxn != null && !string.IsNullOrEmpty(paymentTxn.CardNetwork) && !string.IsNullOrEmpty(paymentTxn.CardLast4)
                    ? $"{paymentTxn.CardNetwork} **** {paymentTxn.CardLast4}" + (!string.IsNullOrEmpty(paymentTxn.CardType) ? $" ({paymentTxn.CardType})" : "")
                    : "";
                var bankName = hasCardDetails && paymentTxn != null && !string.IsNullOrEmpty(paymentTxn.BankName) ? paymentTxn.BankName : "";
                
                <div class="transaction-card refund-pending-card">
                    <div class="transaction-header">
                        <div class="flex-grow-1">
                            <div class="transaction-id">Subscription #@subscription.SubscriptionId</div>
                            <div class="d-flex align-items-center gap-2 mt-1">
                                <span class="type-badge refund-type-badge">Refund</span>
                                <span class="status-badge refund-status-badge">Pending</span>
                            </div>
                        </div>
                        <div class="text-end flex-shrink-0">
                            <div class="transaction-amount refund-amount">₹@subscription.Amount.ToString("N2")</div>
                            <div class="text-muted currency-text">INR</div>
                        </div>
                    </div>

                    <div class="transaction-details">
                        @if (isAdmin && subscription.ChannelPartner != null)
                        {
                            <div class="detail-item">
                                <i class="fa-solid fa-building"></i>
                                <span>@subscription.ChannelPartner.CompanyName</span>
                            </div>
                        }
                        @if (subscription.CancelledOn.HasValue)
                        {
                            <div class="detail-item">
                                <i class="fa-solid fa-calendar"></i>
                                <span>@subscription.CancelledOn.Value.ToString("MMM dd, yyyy HH:mm")</span>
                            </div>
                        }
                        @if (subscription.Plan != null)
                        {
                            <div class="detail-item">
                                <i class="fa-solid fa-layer-group"></i>
                                <span>@subscription.Plan.PlanName (@subscription.BillingCycle.ToLower())</span>
                            </div>
                        }
                        <div class="detail-item">
                            <i class="fa-solid fa-credit-card"></i>
                            <span>@(subscription.PaymentMethod ?? "Razorpay")</span>
                        </div>
                        @if (!string.IsNullOrEmpty(subscription.PaymentTransactionId))
                        {
                            <div class="detail-item">
                                <i class="fa-solid fa-hashtag"></i>
                                <span>@subscription.PaymentTransactionId</span>
                            </div>
                        }
                        @if (subscription.CancelledOn.HasValue)
                        {
                            <div class="detail-item">
                                <i class="fa-solid fa-clock"></i>
                                <span>Cancelled: @subscription.CancelledOn.Value.ToString("MMM dd, yyyy HH:mm")</span>
                            </div>
                        }
                    </div>

                    @if (!string.IsNullOrEmpty(subscription.CancellationReason))
                    {
                        <div class="mt-2">
                            <small class="text-muted">@subscription.CancellationReason</small>
                        </div>
                    }
                    
                    <div class="mt-3">
                        <div class="alert alert-warning refund-alert py-2 mb-0">
                            <i class="fa-solid fa-info-circle me-1"></i>
                            <small class="refund-alert-text">
                                Refund is being processed. Expected within 5-7 business days. Contact support for assistance.
                            </small>
                        </div>
                        
                        @if (User.IsInRole("Admin"))
                        {
                            <div class="mt-2">
                                <button type="button" class="btn btn-sm btn-success" onclick="processRefund(@subscription.SubscriptionId, '@subscription.ChannelPartner?.CompanyName', @subscription.Amount, '@Html.Raw(cardInfo)', '@Html.Raw(bankName)')">
                                    <i class="fa-solid fa-check-circle me-1"></i>Mark Refund as Processed
                                </button>
                            </div>
                        }
                    </div>
                </div>
            }
            
            @if (Model.Any())
            {
                <div class="mb-3 mt-4">
                    <h5 class="mb-3" style="color: var(--bs-body-color); font-weight: 700;">
                        <i class="fa-solid fa-list me-2"></i>Transaction History
                    </h5>
                </div>
            }
        }
        
        @if (Model.Any())
        {
            @foreach (var transaction in Model)
            {
                <div class="transaction-card">
                    <div class="transaction-header">
                        <div class="flex-grow-1">
                            <div class="transaction-id">@transaction.TransactionReference</div>
                            <div class="d-flex align-items-center gap-2 mt-1">
                                <span class="type-badge type-@transaction.TransactionType.ToLower()">@transaction.TransactionType</span>
                                <span class="status-badge status-@transaction.Status.ToLower()">@transaction.Status</span>
                            </div>
                        </div>
                        <div class="text-end flex-shrink-0">
                            <div class="transaction-amount">₹@transaction.Amount.ToString("N2")</div>
                            <div class="text-muted" style="font-size: 0.875rem;">@(transaction.Currency ?? "INR")</div>
                        </div>
                    </div>

                    <div class="transaction-details">
                        @if (isAdmin && transaction.ChannelPartner != null)
                        {
                            <div class="detail-item">
                                <i class="fa-solid fa-building"></i>
                                <span>@transaction.ChannelPartner.CompanyName</span>
                            </div>
                        }
                        <div class="detail-item">
                            <i class="fa-solid fa-calendar"></i>
                            <span>@transaction.TransactionDate.ToString("MMM dd, yyyy HH:mm")</span>
                        </div>
                        @if (!string.IsNullOrEmpty(transaction.PlanName))
                        {
                            <div class="detail-item">
                                <i class="fa-solid fa-layer-group"></i>
                                <span>@transaction.PlanName @(!string.IsNullOrEmpty(transaction.BillingCycle) ? $"({transaction.BillingCycle})" : "")</span>
                            </div>
                        }
                        <div class="detail-item">
                            <i class="fa-solid fa-credit-card"></i>
                            <span>
                                @if (!string.IsNullOrEmpty(transaction.CardNetwork) && !string.IsNullOrEmpty(transaction.CardLast4))
                                {
                                    <text>@transaction.CardNetwork **** @transaction.CardLast4</text>
                                    @if (!string.IsNullOrEmpty(transaction.CardType))
                                    {
                                        <span class="badge bg-secondary ms-1">@transaction.CardType</span>
                                    }
                                }
                                else
                                {
                                    <text>@transaction.PaymentMethod</text>
                                }
                            </span>
                        </div>
                        @if (!string.IsNullOrEmpty(transaction.BankName))
                        {
                            <div class="detail-item">
                                <i class="fa-solid fa-building-columns"></i>
                                <span>@transaction.BankName</span>
                            </div>
                        }
                        @if (!string.IsNullOrEmpty(transaction.RazorpayPaymentId))
                        {
                            <div class="detail-item">
                                <i class="fa-solid fa-hashtag"></i>
                                <span>@transaction.RazorpayPaymentId</span>
                            </div>
                        }
                        @if (transaction.CompletedDate.HasValue)
                        {
                            <div class="detail-item">
                                <i class="fa-solid fa-check-circle"></i>
                                <span>Completed: @transaction.CompletedDate.Value.ToString("MMM dd, yyyy HH:mm")</span>
                            </div>
                        }
                    </div>

                    @if (!string.IsNullOrEmpty(transaction.Description))
                    {
                        <div class="mt-2">
                            <small class="text-muted">@transaction.Description</small>
                        </div>
                    }

                    @if (transaction.TransactionType == "Refund" && transaction.Status == "Pending")
                    {
                        <div class="mt-3">
                            <div class="alert alert-info py-2 mb-0">
                                <i class="fa-solid fa-info-circle me-2"></i>
                                <strong>Refund Processing:</strong>
                                @if (!string.IsNullOrEmpty(transaction.CardNetwork) && !string.IsNullOrEmpty(transaction.CardLast4))
                                {
                                    <text>Amount will be refunded to your <strong>@transaction.CardNetwork **** @transaction.CardLast4</strong> card within 5-7 business days.</text>
                                }
                                else
                                {
                                    <text>Amount will be refunded to your original payment method within 5-7 business days.</text>
                                }
                                @if (isAdmin)
                                {
                                    <br /><small class="text-muted">Click "Mark as Processed" to initiate the Razorpay refund automatically.</small>
                                }
                            </div>
                        </div>
                    }

                    @if (transaction.TransactionType == "Refund" && (transaction.Status == "Processed" || transaction.Status == "Success"))
                    {
                        <div class="mt-3">
                            <div class="alert alert-success py-2 mb-0">
                                <i class="fa-solid fa-check-circle me-2"></i>
                                <strong>Refund Successful:</strong>
                                @if (!string.IsNullOrEmpty(transaction.CardNetwork) && !string.IsNullOrEmpty(transaction.CardLast4))
                                {
                                    if (isAdmin && transaction.ChannelPartner != null)
                                    {
                                        <text>₹@transaction.Amount.ToString("N2") has been refunded to <strong>@transaction.ChannelPartner.CompanyName</strong>'s <strong>@transaction.CardNetwork **** @transaction.CardLast4</strong> card. Money will reach their account within 5-7 business days.</text>
                                    }
                                    else
                                    {
                                        <text>₹@transaction.Amount.ToString("N2") has been refunded to your <strong>@transaction.CardNetwork **** @transaction.CardLast4</strong> card. Money will reach your account within 5-7 business days.</text>
                                    }
                                }
                                else
                                {
                                    if (isAdmin && transaction.ChannelPartner != null)
                                    {
                                        <text>₹@transaction.Amount.ToString("N2") has been refunded to <strong>@transaction.ChannelPartner.CompanyName</strong>'s original payment method. Money will reach their account within 5-7 business days.</text>
                                    }
                                    else
                                    {
                                        <text>₹@transaction.Amount.ToString("N2") has been refunded to your original payment method. Money will reach your account within 5-7 business days.</text>
                                    }
                                }
                                <br /><small class="text-muted">Refund ID: @transaction.TransactionReference</small>
                            </div>
                        </div>
                    }

                    @if (!string.IsNullOrEmpty(transaction.FailureReason))
                    {
                        <div class="mt-2">
                            <div class="alert alert-danger py-2 mb-0">
                                <i class="fa-solid fa-exclamation-triangle me-1"></i>
                                <small>@transaction.FailureReason</small>
                            </div>
                        </div>
                    }
                </div>
            }
        }
        else
        {
            <div class="empty-state">
                <i class="fa-solid fa-credit-card"></i>
                <h3>No Transactions Found</h3>
                <p class="text-muted">
                    @if (isAdmin)
                    {
                        <span>No subscription transactions match your current filters</span>
                    }
                    else
                    {
                        <span>You haven't made any subscription payments yet</span>
                    }
                </p>
                @if (!isAdmin)
                {
                    <a href="/Subscription/MyPlan" class="btn btn-primary mt-3">
                        <i class="fa-solid fa-layer-group me-2"></i>View Plans
                    </a>
                }
            </div>
        }
    </div>
</div>

@section Scripts {
    <script>
        // Auto-submit form function
        function autoSubmitForm() {
            document.querySelector('form').submit();
        }
        
        // Auto-refresh pending transactions every 30 seconds
        @if (Model.Any(t => t.Status == "Pending"))
        {
            <text>
            setInterval(function() {
                const pendingCount = @Model.Count(t => t.Status == "Pending");
                if (pendingCount > 0) {
                    location.reload();
                }
            }, 30000);
            </text>
        }
        
        // Process Refund Function with SweetAlert
        function processRefund(subscriptionId, companyName, amount, cardInfo, bankName) {
            // Build card display
            let cardDisplay = '';
            if (cardInfo) {
                cardDisplay = `
                    <div class="alert alert-info mb-0 mt-2" style="text-align: left;">
                        <p class="mb-1"><strong><i class="fa-solid fa-credit-card me-2"></i>Refund Destination:</strong></p>
                        <p class="mb-1 ms-4">${cardInfo}</p>
                        ${bankName ? `<p class="mb-0 ms-4 text-muted small"><i class="fa-solid fa-building-columns me-1"></i>${bankName}</p>` : ''}
                    </div>
                `;
            }
            
            // Use SweetAlert for confirmation
            Swal.fire({
                title: 'Process Refund',
                html: `
                    <div class="text-start">
                        <p><strong>Partner:</strong> ${companyName}</p>
                        <p><strong>Amount:</strong> ₹${amount.toFixed(2)}</p>
                        ${cardDisplay}
                        <p class="text-muted small mt-3">
                            <i class="fa-solid fa-info-circle me-1"></i>
                            This will initiate a Razorpay refund to the ${cardInfo ? 'above card' : "partner's original payment method (card/UPI/wallet)"}.
                            Refund will be processed within 5-7 business days.
                        </p>
                    </div>
                    <textarea id="refund-notes" class="form-control mt-3" placeholder="Enter refund notes (optional)&#10;e.g., Transaction ID, Date processed, etc." rows="3"></textarea>
                `,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: '<i class="fa-solid fa-check me-1"></i>Process Refund',
                cancelButtonText: '<i class="fa-solid fa-times me-1"></i>Cancel',
                confirmButtonColor: '#28a745',
                cancelButtonColor: '#6c757d',
                showLoaderOnConfirm: true,
                preConfirm: () => {
                    const refundNotes = document.getElementById('refund-notes').value;
                    const token = document.querySelector('input[name="__RequestVerificationToken"]').value;
                    
                    return fetch('/Subscription/MarkRefundProcessed', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                            'RequestVerificationToken': token
                        },
                        body: `subscriptionId=${subscriptionId}&refundNotes=${encodeURIComponent(refundNotes || 'Refund processed by admin')}`
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (!data.success) {
                            throw new Error(data.message);
                        }
                        return data;
                    })
                    .catch(error => {
                        Swal.showValidationMessage(`Request failed: ${error}`);
                    });
                },
                allowOutsideClick: () => !Swal.isLoading()
            }).then((result) => {
                if (result.isConfirmed) {
                    Swal.fire({
                        title: 'Success!',
                        html: result.value.message,
                        icon: 'success',
                        confirmButtonColor: '#28a745'
                    }).then(() => {
                        location.reload();
                    });
                }
            });
        }
    </script>
}